<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FerBot — Panel</title>
<style>
  :root{
    --green:#97C93E; --ink:#E5EDF6; --bg:#0b0f19; --card:#121a2b; --muted:#8ea0b8;
    --bad:#ef4444; --warn:#f59e0b; --ok:#22c55e;
  }
  body{margin:0;background:radial-gradient(1200px 600px at 60% -10%, #12223b 0%, #0b0f19 50%, #0b0f19 100%); color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  .wrap{max-width:980px;margin:42px auto;padding:0 16px;}
  .pill{display:inline-flex;align-items:center;gap:10px;background:#0d1526;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:10px 14px;}
  .dot{width:10px;height:10px;border-radius:999px;background:var(--bad);}
  .dot.warn{background:var(--warn)} .dot.ok{background:var(--ok)}
  .badge{font-size:13px;color:#cbd5e1;}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.35);}
  .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);}
  .title{font-weight:800;letter-spacing:.3px;}
  .body{padding:16px}
  label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px;}
  input,select,textarea{width:100%;background:#0f1524;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:10px;outline:none;padding:10px 12px;font-size:14px}
  textarea{min-height:110px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 240px;gap:12px}
  .footer{display:flex;gap:10px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .primary{background:var(--green);color:#0b0f19}
  .ghost{background:#192236;color:#cbd5e1}
  .hint{font-size:12px;color:#8ea0b8}
  .error{margin-top:10px;color:#ffb4b4;font-size:13px}
  .brand{opacity:.8;margin-top:16px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">FerBot — Panel</div>
        <div class="pill">
          <span id="timerDot" class="dot"></span>
          <span id="timerTxt" class="badge">0.0s</span>
          <span id="sentBadge" class="badge">Neutral</span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <div>
            <label>Nombre del cliente</label>
            <input id="name" placeholder="Ej. Laura" value="Cliente"/>
          </div>
          <div>
            <label>Etapa</label>
            <select id="stage">
              <option value="integracion">Integración</option>
              <option value="sondeo">Sondeo</option>
              <option value="rebatir" selected>Rebatir</option>
              <option value="pre_cierre">Pre-cierre</option>
              <option value="cierre">Cierre</option>
            </select>
          </div>
        </div>

        <label>Contexto (opcional, para el bot)</label>
        <input id="context" placeholder="Ej. preguntó por certificaciones; poco tiempo"/>

        <label>Texto del cliente</label>
        <textarea id="question" placeholder="Pega aquí lo que dijo el cliente o su objeción…"></textarea>

        <label>Explicación (POR QUÉ + SIGUIENTE PASO)</label>
        <textarea id="guide" placeholder="Aquí verás POR QUÉ y SIGUIENTE PASO." readonly></textarea>

        <label>Respuesta (lista para pegar)</label>
        <textarea id="reply" placeholder="Mensaje corto para el cliente (≤ 2 frases)." readonly></textarea>

        <div id="error" class="error" style="display:none"></div>
      </div>
      <div class="footer">
        <button id="go" class="btn primary">Generar</button>
        <button id="clear" class="btn ghost">Clear</button>
        <div class="hint">Servidor: <code id="base"></code></div>
      </div>
    </div>

    <div class="brand hint">Hecho con ❤ FerBot v1.0</div>
  </div>

<script>
  const BASE = location.origin; // mismo dominio (Render)
  document.getElementById("base").textContent = BASE;

  const qEl = document.getElementById("question");
  const nEl = document.getElementById("name");
  const sEl = document.getElementById("stage");
  const cEl = document.getElementById("context");
  const gEl = document.getElementById("guide");
  const rEl = document.getElementById("reply");
  const eEl = document.getElementById("error");

  const tDot = document.getElementById("timerDot");
  const tTxt = document.getElementById("timerTxt");

  // sentimiento simple
  function updateSentiment() {
    const s = (qEl.value||"").toLowerCase();
    let txt = "Neutral", color = "";
    if (/(gracias|excelente|me interesa|genial|perfecto)/.test(s)) { txt="Positivo"; color="ok"; }
    else if (/(no puedo|caro|dificil|malo|no sirve|poco tiempo)/.test(s)) { txt="Negativo"; color="bad"; }
    document.getElementById("sentBadge").textContent = txt;
  }
  qEl.addEventListener("input", updateSentiment);

  // timer
  let t0=0, iv=null;
  function startTimer(){
    stopTimer();
    t0 = performance.now();
    tDot.className = "dot";
    iv = setInterval(()=>{
      const dt = (performance.now()-t0)/1000;
      tTxt.textContent = dt.toFixed(1) + "s";
      if (dt < 2) tDot.className="dot";
      else if (dt < 4) tDot.className="dot warn";
      else tDot.className="dot ok";
    }, 100);
  }
  function stopTimer(){ if (iv) { clearInterval(iv); iv=null; } }

  document.getElementById("go").onclick = async () => {
    eEl.style.display="none"; eEl.textContent="";
    gEl.value=""; rEl.value="";
    const question = (qEl.value||"").trim();
    if (!question){ eEl.textContent="Escribe o pega el texto del cliente."; eEl.style.display="block"; return; }

    startTimer();
    try{
      const resp = await fetch(`${BASE}/assist_trainer`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          question,
          customerName: (nEl.value||"Cliente").trim(),
          stage: (sEl.value||"_default").trim(),
          context: (cEl.value||"").trim()
        })
      });
      stopTimer(); tDot.className="dot ok";
      if (!resp.ok){
        const txt = await resp.text().catch(()=> "");
        eEl.textContent = `No se pudo generar. Verifica la API o tu conexión. ${txt}`;
        eEl.style.display="block";
        return;
      }
      const json = await resp.json();
      const reply = json?.result?.reply || json?.text || "";
      const why = json?.result?.why || "";
      const next = json?.result?.next || "";
      rEl.value = reply;
      gEl.value = `POR QUÉ: ${why}\nSIGUIENTE PASO: ${next}`;
    }catch(err){
      stopTimer();
      eEl.textContent = "No se pudo generar. Verifica la API o tu conexión.";
      eEl.style.display="block";
    }
  };

  document.getElementById("clear").onclick = () => {
    qEl.value=""; gEl.value=""; rEl.value="";
    eEl.style.display="none";
    stopTimer(); tDot.className="dot"; tTxt.textContent="0.0s";
  };
</script>
</body>
</html>
