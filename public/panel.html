<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot · Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{ --green:#97C93E; --dark:#0b0f19; --panel:#0b0f19CC; --ink:#e2e8f0; --muted:#94a3b8; --warn:#fbbf24; --bad:#ef4444; }
    body{margin:0;background:var(--dark);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:900px;margin:22px auto;padding:0 16px;}
    .card{background:#0f1524;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1524;color:#dbeafe;outline:none}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns: 1fr 170px; gap:10px}
    .btns{display:flex;gap:8px;margin-top:10px}
    button{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .signal{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#cbd5e1;background:#121a2b;border:1px solid rgba(255,255,255,.1);border-radius:999px;padding:5px 10px}
    .dot{width:8px;height:8px;border-radius:999px;background:#ef4444}
    .dot.ambar{background:#f59e0b}
    .dot.verde{background:#22c55e}
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 10px">FerBot — Panel</h2>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="signal"><span class="dot" id="b"></span><span id="t">0.0s</span></div>
        <small id="base" style="opacity:.75"></small>
      </div>

      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura">
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integración</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label style="margin-top:6px">Contexto (opcional, para el bot)</label>
      <input id="ctx" placeholder="Ej. preguntó por certificaciones; tiene poco tiempo">

      <label style="margin-top:6px">Texto del cliente</label>
      <textarea id="q" placeholder="Escribe el mensaje del cliente…"></textarea>

      <label style="margin-top:6px">Explicación (POR QUÉ + SIGUIENTE PASO)</label>
      <textarea id="guide" placeholder="Aquí el bot te enseña…"></textarea>

      <label style="margin-top:6px">Respuesta (lista para pegar)</label>
      <textarea id="out" placeholder="Se generará aquí…"></textarea>

      <div class="btns">
        <button class="primary" id="gen">Generar</button>
        <button class="ghost" id="clear">Clear</button>
      </div>
    </div>
  </div>

<script>
const DEFAULT_BASE = "https://ferbot-api.onrender.com";
const BASE = localStorage.getItem("ferbot_api_base") || DEFAULT_BASE;
document.getElementById("base").textContent = BASE;

// timer
const bullet = document.getElementById("b"); const timer = document.getElementById("t");
let iv=null, t0=0;
function startTimer(){ stopTimer(); t0=performance.now(); setBullet('rojo'); iv=setInterval(()=>{const dt=(performance.now()-t0)/1000; timer.textContent=dt.toFixed(1)+'s'; if(dt<2)setBullet('rojo'); else if(dt<4)setBullet('ambar'); else setBullet('verde');},100); }
function stopTimer(){ if(iv){clearInterval(iv); iv=null;} }
function setBullet(c){ bullet.classList.remove('ambar','verde'); if(c==='ambar')bullet.classList.add('ambar'); else if(c==='verde') bullet.classList.add('verde'); }

const q=document.getElementById('q'), nameEl=document.getElementById('name'), stage=document.getElementById('stage'), ctx=document.getElementById('ctx'), out=document.getElementById('out'), guide=document.getElementById('guide');

document.getElementById('gen').onclick=async()=>{
  const txt=(q.value||'').trim(); if(!txt){ alert('Escribe el texto del cliente'); return; }
  out.value=""; guide.value="";
  startTimer();
  const body={ question:txt, customerName:(nameEl.value||'').trim()||'Cliente', stage:stage.value, context:(ctx.value||'').trim() };
  try{
    const r=await fetch(BASE+'/assist_trainer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    stopTimer(); setBullet('verde');
    if(!r.ok){ const t=await r.text().catch(()=> ''); alert('Error: '+t); return;}
    const j=await r.json();
    const reply=(j?.result?.reply||j?.text||'').trim();
    const why=(j?.result?.why||'').trim();
    const next=(j?.result?.next||'').trim();
    out.value=reply; guide.value=`POR QUÉ: ${why}\nSIGUIENTE PASO: ${next}`;
  }catch(e){ stopTimer(); alert('No se pudo generar'); }
};
document.getElementById('clear').onclick=()=>{ out.value=''; guide.value=''; stopTimer(); timer.textContent='0.0s'; setBullet('rojo'); };
</script>
</body>
</html>

