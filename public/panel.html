<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ¬∑ Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --green:#97C93E; --dark:#0b0f19; --panel:#0b0f19CC; --ink:#e2e8f0; --muted:#94a3b8;
      --ok:#19c37d; --warn:#fbbf24; --bad:#ef4444;
    }
    body{margin:0;background:var(--dark);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px;}
    .card{background:#0f1524;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0f1524;color:#dbeafe;outline:none;font-size:14px
    }
    textarea{min-height:100px;resize:vertical;white-space:pre-wrap} /* <- muestra todo */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:#101727}
    .dot{width:8px;height:8px;border-radius:999px;background:#64748b}
    .pos .dot{background:#19c37d} .neu .dot{background:#f59e0b} .neg .dot{background:#ef4444}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .timer{font-variant-numeric:tabular-nums;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2 style="margin:0">FerBot ‚Äî Panel</h2>
      <div class="pill"><span id="dot" class="dot"></span><span id="timer" class="timer">0.0s</span></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label style="margin-top:8px">Contexto (opcional, para el bot)</label>
      <input id="context" placeholder="Notas breves: certificaciones, poco tiempo, habl√≥ de ingl√©s..."/>

      <div class="row" style="align-items:end;margin-top:8px">
        <div>
          <label>Texto del cliente</label>
          <textarea id="input" placeholder="Escribe aqu√≠ lo que dijo el cliente‚Ä¶"></textarea>
        </div>
        <div>
          <label>Sentimiento</label>
          <div id="sent" class="pill neu"><span class="dot"></span><span id="sentText">Neutral</span></div>
        </div>
      </div>

      <label style="margin-top:8px">Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
      <textarea id="guide" placeholder="Aqu√≠ el bot te ense√±a‚Ä¶"></textarea>

      <label style="margin-top:8px">Respuesta (lista para pegar)</label>
      <textarea id="output" placeholder="Se generar√° aqu√≠‚Ä¶"></textarea>

      <div class="btns">
        <button id="gen"  class="primary">Generar</button>
        <button id="clr"  class="ghost">Clear</button>
        <button id="good" class="ghost" style="display:none">üëç Buena</button>
        <button id="reg"  class="ghost" style="display:none">üòê Regular</button>
        <button id="bad"  class="ghost" style="display:none">üëé Mala</button>
      </div>
    </div>
  </div>

  <script>
    // ===== BASE de la API =====
    const BASE = (localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com").replace(/\/+$/,"");

    // ===== refs
    const nameEl = document.getElementById('name');
    const stageEl= document.getElementById('stage');
    const ctxEl  = document.getElementById('context');
    const inEl   = document.getElementById('input');
    const outEl  = document.getElementById('output');
    const guideEl= document.getElementById('guide');

    const genBtn = document.getElementById('gen');
    const clrBtn = document.getElementById('clr');

    const goodBtn= document.getElementById('good');
    const regBtn = document.getElementById('reg');
    const badBtn = document.getElementById('bad');

    const dot    = document.getElementById('dot');
    const timer  = document.getElementById('timer');

    // ===== helpers UI
    function setDot(c){ dot.style.background = c; }
    function autoResize(t){ if(!t) return; t.style.height="auto"; t.style.height=(t.scrollHeight+4)+"px"; }

    function guessIntent(q=""){
      const s = (q||"").toLowerCase();
      if (/(tiempo|no tengo tiempo|poco tiempo|agenda|horario|no alcanzo|ocupad)/.test(s)) return "tiempo";
      if (/(precio|caro|costo|costoso|vale|promoci|oferta|descuento)/.test(s)) return "precio";
      if (/(cert|certificado|certificaci√≥n|certificaciones)/.test(s)) return "cert";
      if (/(coursera|udemy|alura|competenc)/.test(s)) return "competencia";
      if (/(qu√© es platzi|que es platzi|platzi|pitch)/.test(s)) return "pitch";
      return "_panel";
    }

    function updateSentimentBadge(text){
      const s = (text||"").toLowerCase();
      const positive = /(gracias|excelente|me interesa|bien|listo|perfecto|genial)/i.test(s);
      const negative = /(no puedo|caro|dificil|malo|no me gusta|no sirve|no tengo tiempo|no s√©|no se)/i.test(s);
      const pill = document.getElementById('sent');
      const label= document.getElementById('sentText');
      pill.classList.remove('pos','neu','neg');
      if (negative){ pill.classList.add('neg'); label.textContent="Negativo"; }
      else if (positive){ pill.classList.add('pos'); label.textContent="Positivo"; }
      else { pill.classList.add('neu'); label.textContent="Neutral"; }
    }
    inEl.addEventListener('input', ()=> updateSentimentBadge(inEl.value));

    // ===== contador
    let t0=0, iv=null;
    function startTimer(){
      stopTimer(); t0=performance.now();
      iv = setInterval(()=>{
        const dt=(performance.now()-t0)/1000;
        timer.textContent = dt.toFixed(1)+"s";
        if (dt<2) setDot("#ef4444");
        else if (dt<4) setDot("#f59e0b");
        else setDot("#22c55e");
      },100);
    }
    function stopTimer(){ if (iv){ clearInterval(iv); iv=null; } }

    // ===== Rating toggle
    function toggleRatings(show){
      goodBtn.style.display = show ? "inline-block" : "none";
      regBtn.style.display  = show ? "inline-block" : "none";
      badBtn.style.display  = show ? "inline-block" : "none";
    }
    toggleRatings(false);

    // ===== Evento: Generar
    genBtn.onclick = async () => {
      const q = (inEl.value || "").trim();
      if (!q){ alert("Escribe el texto del cliente primero."); return; }
      const name = (nameEl.value || "Cliente").trim();
      const stage= stageEl.value;
      const context=(ctxEl.value || "").trim();

      outEl.value = ""; guideEl.value=""; autoResize(outEl); autoResize(guideEl);
      toggleRatings(false);

      // contador
      startTimer(); setDot("#ef4444");

      try{
        const res = await fetch(`${BASE}/assist_trainer`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ question:q, customerName:name, stage, context, intent:guessIntent(q) })
        });
        stopTimer(); setDot("#22c55e");

        if (!res.ok){
          const txt = await res.text().catch(()=> "");
          alert(`No se pudo generar (HTTP ${res.status}). ${txt || ""}`);
          return;
        }
        const json = await res.json();
        const reply = (json?.result?.reply || json?.text || "").trim();
        const why   = (json?.result?.why  || "").trim();
        const next  = (json?.result?.next || "").trim();

        outEl.value  = reply;
        guideEl.value= `POR QU√â: ${why}\nSIGUIENTE PASO: ${next}`;
        autoResize(outEl); autoResize(guideEl);

        // mostramos rating
        const intent = guessIntent(q);
        goodBtn.onclick = ()=> sendRate("good", intent, stage, reply);
        regBtn.onclick  = ()=> sendRate("regular", intent, stage, reply);
        badBtn.onclick  = ()=> sendRate("bad", intent, stage, reply);
        toggleRatings(true);
      }catch(e){
        stopTimer(); setDot("#ef4444");
        alert("No se pudo generar. Verifica que la API est√© arriba.");
      }
    };

    async function sendRate(rating, intent, stage, text){
      try{
        await fetch(`${BASE}/trackRate`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ intent, stage, text, rating })
        });
      }catch(_){}
      toggleRatings(false);
    }

    // ===== Clear
    clrBtn.onclick = ()=>{
      outEl.value=""; guideEl.value=""; autoResize(outEl); autoResize(guideEl);
      stopTimer(); timer.textContent="0.0s"; setDot("#64748b");
      toggleRatings(false);
    };

    // ===== saludito de Health (opcional)
    fetch(`${BASE}/health`).then(r=>r.json()).then(j=>console.log("health:", j)).catch(()=>{});
  </script>
</body>
</html>
