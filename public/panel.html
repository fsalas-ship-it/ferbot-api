<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ¬∑ Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --green:#97C93E; --dark:#0b0f19; --panel:#0b0f19CC; --ink:#e2e8f0; --muted:#94a3b8;
      --ok:#19c37d; --warn:#fbbf24; --bad:#ef4444;
    }
    body{margin:0;background:var(--dark);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px;}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:16px}
    .card{background:#0f1524;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0f1524;color:#dbeafe;outline:none;font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{
      padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;
    }
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:#1b2333;color:#cbd5e1;font-size:12px;border:1px solid rgba(255,255,255,.08)
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--bad);box-shadow:0 0 10px var(--bad)}
    .dot.warn{background:var(--warn);box-shadow:0 0 10px var(--warn)}
    .dot.ok{background:var(--ok);box-shadow:0 0 10px var(--ok)}
    .outbox{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#cbd5e1}
    .rate{display:none;gap:6px;margin-top:8px}
    .rate.show{display:flex}
    .rate button{font-size:12px}
    .love{margin-top:14px;color:var(--muted);font-size:12px}
    .love b{color:var(--green)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FerBot ¬∑ Panel</h1>
    <div class="sub">Emergencia/consulta r√°pida ‚Äî usa el mismo backend que la extensi√≥n.</div>

    <div class="card">
      <label>API Base (opcional, se guarda)</label>
      <input id="base" placeholder="https://ferbot-api.onrender.com"/>

      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label>Contexto (opcional)</label>
      <input id="ctx" placeholder="Ej. trabaja y solo puede 10 min al d√≠a"/>

      <label>Texto del cliente (selecci√≥n o pega aqu√≠)</label>
      <textarea id="q" placeholder="No tengo tiempo para estudiar‚Ä¶"></textarea>

      <div class="btns">
        <button id="go" class="primary">Generar</button>
        <button id="clear" class="ghost">Clear</button>
        <span id="pulse" class="pill" style="display:none">
          <span class="dot" id="dot"></span>
          <span id="tlabel">Generando‚Ä¶ 0.0s</span>
        </span>
      </div>

      <div class="outbox">
        <div>
          <label>POR QU√â</label>
          <textarea id="why" readonly></textarea>
        </div>
        <div>
          <label>SIGUIENTE PASO</label>
          <textarea id="next" readonly></textarea>
        </div>
        <div>
          <label>Respuesta para pegar</label>
          <textarea id="reply" readonly></textarea>
          <div id="rate" class="rate">
            <button id="r-good" class="primary">üëç Buena</button>
            <button id="r-regular" class="ghost">üòê Regular</button>
            <button id="r-bad" class="ghost" style="background:#2a1c1c;color:#fff">üëé Mala</button>
          </div>
        </div>
        <div class="mono" id="dbg"></div>
      </div>

      <div class="love">Hecho con amor <b>üíö</b></div>
    </div>
  </div>

  <script>
    // === CONFIG BASE ===
    const baseEl = document.getElementById('base');
    const saved = localStorage.getItem('ferbot_api_base');
    const BASE = (saved && saved.trim()) || 'https://ferbot-api.onrender.com';
    baseEl.value = BASE;
    baseEl.addEventListener('change', ()=>{
      localStorage.setItem('ferbot_api_base', baseEl.value.trim());
    });

    // === REFS ===
    const qEl = document.getElementById('q');
    const nameEl = document.getElementById('name');
    const stageEl = document.getElementById('stage');
    const ctxEl = document.getElementById('ctx');
    const whyEl = document.getElementById('why');
    const nextEl = document.getElementById('next');
    const replyEl = document.getElementById('reply');
    const dbgEl = document.getElementById('dbg');
    const rateBox = document.getElementById('rate');
    const rGood = document.getElementById('r-good');
    const rReg  = document.getElementById('r-regular');
    const rBad  = document.getElementById('r-bad');

    const pulse = document.getElementById('pulse');
    const dot   = document.getElementById('dot');
    const tlabel= document.getElementById('tlabel');

    // === COUNTDOWN ===
    let t0=0, tick=null;
    function startPulse(){
      t0=performance.now();
      pulse.style.display='inline-flex';
      dot.className='dot';
      tlabel.textContent='Generando‚Ä¶ 0.0s';
      if (tick) clearInterval(tick);
      tick=setInterval(()=>{
        const dt=(performance.now()-t0)/1000;
        tlabel.textContent=`Generando‚Ä¶ ${dt.toFixed(1)}s`;
        if (dt<2){ dot.className='dot'; }
        else if (dt<5){ dot.className='dot warn'; }
        else { dot.className='dot ok'; }
      },100);
    }
    function stopPulse(){
      if (tick) { clearInterval(tick); tick=null; }
      const dt=(performance.now()-t0)/1000;
      dot.className='dot ok';
      tlabel.textContent=`Listo en ${dt.toFixed(1)}s`;
      setTimeout(()=>{ pulse.style.display='none'; }, 1200);
    }

    function guessIntent(s=''){
      s=s.toLowerCase();
      if (/(tiempo|no tengo tiempo|poco tiempo|agenda|horario|no alcanzo)/.test(s)) return 'tiempo';
      if (/(precio|caro|costo|vale|promoci|oferta|descuento)/.test(s)) return 'precio';
      if (/(cert|certificado|certificacion|certificaci√≥n)/.test(s)) return 'cert';
      if (/(coursera|udemy|alura|competenc)/.test(s)) return 'competencia';
      if (/(pitch|qu√© es platzi|que es platzi|platzi)/.test(s)) return 'pitch';
      return '_default';
    }

    function showRatingOnce(){
      rateBox.classList.add('show');
      const disableAll=()=>{
        rateBox.classList.remove('show');
        rGood.disabled=rReg.disabled=rBad.disabled=true;
        setTimeout(()=>{ rGood.disabled=rReg.disabled=rBad.disabled=false; }, 800); // rearmar para la pr√≥xima generaci√≥n
      };
      rGood.onclick = ()=> { sendRate('good'); disableAll(); };
      rReg.onclick  = ()=> { sendRate('regular'); disableAll(); };
      rBad.onclick  = ()=> { sendRate('bad'); disableAll(); };
    }

    async function sendRate(rating){
      const intent = guessIntent(qEl.value||'');
      const stage  = stageEl.value;
      const text   = (replyEl.value||'').trim();
      if (!text) return;
      try{
        await fetch((baseEl.value||'') + '/trackRate', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ intent, stage, text, rating })
        });
      }catch(_){}
    }

    document.getElementById('go').onclick = async ()=>{
      const base = (baseEl.value||'').trim();
      const q = (qEl.value||'').trim();
      if (!q){ alert('Escribe el texto del cliente.'); return; }

      whyEl.value = ''; nextEl.value=''; replyEl.value=''; dbgEl.textContent='';
      showRatingOnce(); // se mostrar√°; se ocultar√° al calificar
      startPulse();

      try{
        const res = await fetch(base + '/assist_trainer', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            question: q,
            customerName: (nameEl.value||'').trim() || 'Cliente',
            stage: stageEl.value,
            context: (ctxEl.value||'').trim()
          })
        });
        const json = await res.json().catch(()=> ({}));
        stopPulse();

        // parse
        const why  = (json?.result?.why  || json?.result?.guide || '').toString().trim();
        const next = (json?.result?.next || '').toString().trim();
        const rep  = (json?.result?.reply|| json?.text || '').toString().trim();

        whyEl.value  = why || '-';
        nextEl.value = next || '-';
        replyEl.value= rep  || '-';

        dbgEl.textContent = JSON.stringify({intent: json?.result?.intent, model: json?.result?.model}, null, 2);
      }catch(e){
        stopPulse();
        dbgEl.textContent = 'Error: ' + (e?.message||e);
        alert('No se pudo generar. ¬øAPI vigente?');
      }
    };

    document.getElementById('clear').onclick = ()=>{
      whyEl.value=nextEl.value=replyEl.value=''; dbgEl.textContent='';
    };
  </script>
</body>
</html>

