<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ¬∑ Usabilidad ‚ö°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --ink:#e2e8f0; --muted:#94a3b8; --bg:#0b0f19; --panel:#0f1524; --line:rgba(255,255,255,.1); --green:#97C93E; }
    *{ box-sizing:border-box }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--panel);border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .wrap{padding:16px;max-width:1400px;margin:0 auto}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h3{margin:0 0 4px;font-size:12px;color:var(--muted)}
    .card .val{font-size:22px;font-weight:800}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:16px}
    canvas{height:280px !important;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    table{width:100%;border-collapse:collapse;margin-top:16px;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
    th{background:rgba(255,255,255,.05);text-align:left;color:var(--ink)}
    tr:hover{background:rgba(255,255,255,.03)}
    footer{padding:8px 20px;border-top:1px solid var(--line);color:var(--muted);font-size:12px;text-align:center;margin-top:16px}
    .pill{display:inline-flex;gap:8px;align-items:center}
    .dot{width:8px;height:8px;border-radius:999px;background:#10b981}
  </style>
</head>
<body>
  <header>
    <h1>FerBot ¬∑ Usabilidad ‚ö°</h1>
    <div class="muted"><span id="status">Conectando‚Ä¶</span> ¬∑ auto-refresh <b>5s</b></div>
  </header>

  <div class="wrap">
    <section class="cards" id="cards">
      <div class="card"><h3>Respuestas mostradas</h3><div id="c_shown" class="val">0</div></div>
      <div class="card"><h3>Winrate compuesto</h3><div id="c_wr" class="val">0%</div></div>
      <div class="card"><h3>üëç Buenas</h3><div id="c_good" class="val">0</div></div>
      <div class="card"><h3>üòê Regulares</h3><div id="c_regular" class="val">0</div></div>
      <div class="card"><h3>üëé Malas</h3><div id="c_bad" class="val">0</div></div>
      <div class="card"><h3>Activos 5m</h3><div id="c_act5" class="val">0</div></div>
      <div class="card"><h3>Activos hoy</h3><div id="c_actDay" class="val">0</div></div>
      <div class="card"><h3>‚è±Ô∏è Prom. respuesta</h3><div id="c_avg" class="val">0 ms</div></div>
      <div class="card"><h3>p95 respuesta</h3><div id="c_p95" class="val">0 ms</div></div>
      <div class="card"><h3>Duraci√≥n sesi√≥n prom.</h3><div id="c_sess" class="val">0 min</div></div>
    </section>

    <section class="charts">
      <canvas id="ch_stage"></canvas>
      <canvas id="ch_intent"></canvas>
      <canvas id="ch_hour" style="grid-column:1/-1"></canvas>
      <canvas id="ch_dist" style="grid-column:1/-1"></canvas>
    </section>

    <h3 style="margin-top:16px">Top respuestas (efectivas)</h3>
    <table id="tbl">
      <thead><tr><th>Intent</th><th>Stage</th><th>Texto</th><th>Shown</th><th>Wins</th><th>Winrate</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>FerBot Dashboard ‚Äî Datos en vivo desde <span id="base"></span></footer>

  <script>
    const BASE = (localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com").replace(/\/+$/,"");
    document.getElementById("base").textContent = BASE;

    const ctxStage  = document.getElementById("ch_stage").getContext("2d");
    const ctxIntent = document.getElementById("ch_intent").getContext("2d");
    const ctxHour   = document.getElementById("ch_hour").getContext("2d");
    const ctxDist   = document.getElementById("ch_dist").getContext("2d");

    let chStage, chIntent, chHour, chDist;

    function colors(n){
      const base = ['#97C93E','#60A5FA','#F59E0B','#10B981','#8B5CF6','#EF4444','#0EA5E9','#EAB308','#EC4899','#22C55E'];
      const out = []; for (let i=0;i<n;i++) out.push(base[i % base.length]); return out;
    }

    async function load(){
      try{
        const r = await fetch(`${BASE}/metrics`);
        if(!r.ok) throw new Error("metrics");
        const j = await r.json();
        document.getElementById("status").textContent = "Online ‚úÖ";
        render(j);
      }catch(e){
        document.getElementById("status").textContent = "Offline ‚ùå";
      }
    }

    function render(m){
      const s = m.summary || {};
      set("c_shown", s.shown);
      set("c_wr", (s.winrate||0)+"%");
      set("c_good", s.good||0);
      set("c_regular", s.regular||0);
      set("c_bad", s.bad||0);
      set("c_act5", s.active_5m||0);
      set("c_actDay", s.active_today||0);
      set("c_avg", (s.avg_response_ms||0)+" ms");
      set("c_p95", (s.p95_response_ms||0)+" ms");
      set("c_sess", (s.avg_session_min||0)+" min");

      const rows = m.rows||[];
      // charts: por etapa / por intento
      const stageMap = {}; const intentMap = {};
      rows.forEach(r => {
        stageMap[r.stage]  = (stageMap[r.stage]||0) + r.shown;
        intentMap[r.intent]= (intentMap[r.intent]||0) + r.shown;
      });

      doughnut(chStage, stageMap, "Por etapa", v => chStage=v);
      doughnut(chIntent, intentMap, "Por intento", v => chIntent=v);

      // por hora
      const labels = (m.per_hour||[]).map(x=>x.label);
      const counts = (m.per_hour||[]).map(x=>x.count);
      if (chHour) chHour.destroy();
      chHour = new Chart(ctxHour, {
        type:'line',
        data:{ labels, datasets:[{ label:"Consultas por hora (24h)", data:counts, tension:.3, fill:true }]},
        options:{ plugins:{ legend:{ labels:{ color:'#cbd5e1'} }, title:{display:true,text:'Consultas por hora (24h)', color:'#fff'}},
                  scales:{ x:{ ticks:{ color:'#cbd5e1'} }, y:{ ticks:{ color:'#cbd5e1'} } } }
      });

      // dist calificaciones
      const g = rows.reduce((acc,r)=>{acc.g+=r.good||0; acc.r+=r.regular||0; acc.b+=r.bad||0; return acc;},{g:0,r:0,b:0});
      if (chDist) chDist.destroy();
      chDist = new Chart(ctxDist, {
        type:'bar',
        data:{ labels:['Buenas','Regulares','Malas'], datasets:[{ data:[g.g,g.r,g.b], backgroundColor:['#22c55e','#fbbf24','#ef4444']}] },
        options:{ plugins:{ legend:{ display:false }, title:{ display:true, text:'Distribuci√≥n de calificaciones', color:'#fff' }},
                  scales:{ x:{ ticks:{ color:'#cbd5e1'} }, y:{ ticks:{ color:'#cbd5e1'} } } }
      });

      // tabla
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = rows.slice(0,30).map(r=>`
        <tr>
          <td>${r.intent}</td>
          <td>${r.stage}</td>
          <td>${r.text}</td>
          <td>${r.shown}</td>
          <td>${r.wins}</td>
          <td>${(r.winrate*100).toFixed(1)}%</td>
        </tr>
      `).join("");
    }

    function set(id,val){ document.getElementById(id).textContent = val; }

    function doughnut(ref, map, title, setter){
      const labels = Object.keys(map);
      const data = Object.values(map);
      if (ref) ref.destroy();
      const c = new Chart(
        title==="Por etapa"?ctxStage:ctxIntent,
        { type:'doughnut',
          data:{ labels, datasets:[{ data, backgroundColor:colors(labels.length) }] },
          options:{ plugins:{ legend:{ labels:{ color:'#cbd5e1'} }, title:{ display:true, text:title, color:'#fff' } } }
        }
      );
      setter(c);
    }

    load();
    setInterval(load, 5000);
  </script>
</body>
</html>
