<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FerBot ¬∑ Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b0f19; --panel:#0f1524; --muted:#94a3b8; --fg:#e2e8f0; --green:#97C93E;
    --card:#0f1524; --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg);}
  header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04)}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .brand .dot{width:10px;height:10px;border-radius:10px;background:var(--green);box-shadow:0 0 16px rgba(151,201,62,.5)}
  .grid{display:grid;gap:14px;padding:16px; grid-template-columns: 1.2fr .8fr;}
  @media (max-width: 1100px){ .grid{grid-template-columns: 1fr;} }

  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){ .kpis{grid-template-columns:repeat(2,1fr);} }
  .kpi{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)); border:1px solid var(--border); border-radius:12px; padding:12px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-size:22px;font-weight:800;margin-top:4px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
  .row{display:flex;gap:14px}
  .col{flex:1}
  .h{font-weight:800;margin:0 0 8px 0;font-size:14px}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px}
  th{text-align:left;color:var(--muted)}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .form input, .form select, .form textarea, .form button{
    background:#0b1222;color:#dbeafe;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:13px;outline:none
  }
  .form textarea{grid-column:1/-1;min-height:90px;resize:vertical}
  .form button{background:var(--green);color:#0b0f19;font-weight:800;cursor:pointer}
  .hint{font-size:12px;color:var(--muted)}
  .ok{color:#22c55e} .warn{color:#fbbf24} .bad{color:#ef4444}
</style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span> FerBot ¬∑ Panel unificado</div>
    <div class="pill" id="health">API: comprobando‚Ä¶</div>
  </header>

  <main class="grid">
    <!-- IZQUIERDA: KPI + Gr√°ficas + Tabla -->
    <section class="card">
      <div class="kpis">
        <div class="kpi"><div class="label">Consultas (24h)</div><div class="value" id="kpi-req-24">-</div></div>
        <div class="kpi"><div class="label">Usuarios activos (5m/1h/24h)</div><div class="value" id="kpi-actives">-</div></div>
        <div class="kpi"><div class="label">Latencia prom. (24h)</div><div class="value" id="kpi-lat">-</div></div>
        <div class="kpi"><div class="label">Winrate (24h)</div><div class="value" id="kpi-win">-</div></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="col card">
          <h3 class="h">Actividad por hora (24h)</h3>
          <canvas id="chartByHour"></canvas>
        </div>
        <div class="col card">
          <h3 class="h">Distribuci√≥n</h3>
          <div class="row">
            <div class="col">
              <div class="muted" style="margin-bottom:6px">Por etapa</div>
              <canvas id="chartStage"></canvas>
            </div>
            <div class="col">
              <div class="muted" style="margin-bottom:6px">Por intento</div>
              <canvas id="chartIntent"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="h">√öltimas respuestas</h3>
        <table id="tbl-recent">
          <thead><tr><th>Hora</th><th>Intent</th><th>Etapa</th><th>ms</th><th>Consulta (snippet)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- DERECHA: Consola de prueba r√°pida -->
    <aside class="card">
      <h3 class="h">Consulta de emergencia</h3>
      <div class="hint">Usa el trainer (REPLY + WHY + NEXT). Esto tambi√©n alimenta la telemetr√≠a.</div>
      <div class="form" style="margin-top:8px">
        <input id="name" placeholder="Nombre del cliente (opcional)"/>
        <select id="stage">
          <option value="integracion">Integraci√≥n</option>
          <option value="sondeo">Sondeo</option>
          <option value="pre_cierre">Pre-cierre</option>
          <option value="rebatir" selected>Rebatir</option>
          <option value="cierre">Cierre</option>
        </select>
        <input id="context" placeholder="Contexto (opcional)"/>
        <textarea id="question" placeholder="Mensaje/objeci√≥n del cliente‚Ä¶"></textarea>
        <button id="btnSend">Generar</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="muted">REPLY</div>
        <div id="out-reply" style="margin-top:6px"></div>
        <div style="margin-top:10px" class="muted">POR QU√â + SIGUIENTE PASO</div>
        <div id="out-why" style="margin-top:6px"></div>
        <div id="out-next" style="margin-top:4px"></div>
        <div id="lat" class="hint" style="margin-top:12px"></div>
        <div id="rate" style="margin-top:10px; display:none">
          <button data-r="good"   style="margin-right:6px">üëç Buena</button>
          <button data-r="regular"style="margin-right:6px">üòê Regular</button>
          <button data-r="bad">üëé Mala</button>
        </div>
      </div>
    </aside>
  </main>

<script>
const BASE = location.origin; // sirve desde Render mismo
let chartByHour, chartStage, chartIntent;
let lastReplyText = "", lastStage = "rebatir", lastIntent = "_default";

// Health
async function pingHealth(){
  try{
    const r = await fetch(`${BASE}/health`);
    const j = await r.json();
    const h = document.getElementById("health");
    if (j.ok && j.openai) { h.innerHTML = 'API: <span class="ok">OK</span>'; }
    else { h.innerHTML = 'API: <span class="warn">degradada</span>'; }
  }catch{
    document.getElementById("health").innerHTML = 'API: <span class="bad">offline</span>';
  }
}

// Uso (JSON)
async function loadUsage(){
  try{
    const r = await fetch(`${BASE}/admin/usage`, {cache:"no-store"});
    const j = await r.json();
    if(!j.ok) return;

    // KPIs
    document.getElementById("kpi-req-24").textContent = j.totals.last_24h ?? 0;
    document.getElementById("kpi-actives").textContent = `${j.kpis.activeUsers5m}/${j.kpis.activeUsers1h}/${j.kpis.activeUsers24h}`;
    document.getElementById("kpi-lat").textContent = (j.kpis.avgLatencyMs24h || 0) + " ms";
    document.getElementById("kpi-win").textContent = ((j.ratings24.winrate||0)*100).toFixed(1) + "%";

    // Tabla recientes
    const tb = document.querySelector("#tbl-recent tbody");
    tb.innerHTML = (j.recent||[]).map(e=>{
      const t = new Date(e.ts);
      const hh = t.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      return `<tr>
        <td>${hh}</td><td>${e.intent||"-"}</td><td>${e.stage||"-"}</td>
        <td>${e.ms||0}</td><td class="muted">${escapeHtml(e.q||"")}</td>
      </tr>`;
    }).join("");

    // Gr√°fica por hora
    const labels = (j.byHour24||[]).map(e=> new Date(e.hourISO).toLocaleTimeString([], {hour:"2-digit"}));
    const data = (j.byHour24||[]).map(e=> e.count);
    if (!chartByHour){
      chartByHour = new Chart(document.getElementById("chartByHour"), {
        type: 'line',
        data: { labels, datasets: [{ label:'consultas/h', data, tension:.3 }] },
        options: {
          animation:false,
          plugins:{ legend:{labels:{color:"#cbd5e1"}} },
          scales:{ x:{ ticks:{color:"#94a3b8"}}, y:{ ticks:{color:"#94a3b8"} } }
        }
      });
    }else{
      chartByHour.data.labels = labels;
      chartByHour.data.datasets[0].data = data;
      chartByHour.update();
    }

    // Donas etapa / intento
    const stageLabels = Object.keys(j.byStage24||{});
    const stageData = stageLabels.map(k=> j.byStage24[k]);
    if (!chartStage){
      chartStage = new Chart(document.getElementById("chartStage"), {
        type:'doughnut',
        data:{ labels:stageLabels, datasets:[{ data:stageData }] },
        options:{ plugins:{ legend:{labels:{color:"#cbd5e1"}} } }
      });
    }else{
      chartStage.data.labels = stageLabels;
      chartStage.data.datasets[0].data = stageData;
      chartStage.update();
    }

    const intentLabels = Object.keys(j.byIntent24||{});
    const intentData = intentLabels.map(k=> j.byIntent24[k]);
    if (!chartIntent){
      chartIntent = new Chart(document.getElementById("chartIntent"), {
        type:'doughnut',
        data:{ labels:intentLabels, datasets:[{ data:intentData }] },
        options:{ plugins:{ legend:{labels:{color:"#cbd5e1"}} } }
      });
    }else{
      chartIntent.data.labels = intentLabels;
      chartIntent.data.datasets[0].data = intentData;
      chartIntent.update();
    }

  }catch(e){
    // silencio
  }
}

function escapeHtml(s=""){return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

document.getElementById("btnSend").onclick = async ()=>{
  const name = document.getElementById("name").value.trim();
  const stage = document.getElementById("stage").value;
  const context = document.getElementById("context").value.trim();
  const question = document.getElementById("question").value.trim();
  if (!question){ alert("Escribe la objeci√≥n/mensaje del cliente."); return; }

  const t0 = performance.now();
  try{
    const res = await fetch(`${BASE}/assist_trainer`, {
      method:"POST",
      headers: { "Content-Type":"application/json", "x-ferbot-source":"panel" },
      body: JSON.stringify({ question, customerName:name, stage, context })
    });
    if (!res.ok){
      const txt = await res.text().catch(()=> "");
      alert(`No se pudo generar (HTTP ${res.status}). ${txt || ""}`);
      return;
    }
    const j = await res.json();
    const reply = (j?.result?.reply || j?.text || "").trim();
    const why   = (j?.result?.why  || "").trim();
    const next  = (j?.result?.next || "").trim();

    lastReplyText = reply;
    lastStage = stage;
    lastIntent = j?.result?.intent || "_default";

    document.getElementById("out-reply").textContent = reply || "(sin respuesta)";
    document.getElementById("out-why").textContent   = "POR QU√â: " + (why || "-");
    document.getElementById("out-next").textContent  = "SIGUIENTE PASO: " + (next || "-");
    const ms = Math.round(performance.now()-t0);
    document.getElementById("lat").textContent = `Tiempo: ${ms} ms`;

    // Mostrar rating 1-vez
    const rate = document.getElementById("rate");
    rate.style.display = "block";
    for (const btn of rate.querySelectorAll("button")){
      btn.onclick = async ()=>{
        const rating = btn.getAttribute("data-r");
        try{
          await fetch(`${BASE}/trackRate`, {
            method:"POST",
            headers:{ "Content-Type":"application/json", "x-ferbot-source":"panel" },
            body: JSON.stringify({ intent:lastIntent, stage:lastStage, text:lastReplyText, rating })
          });
        }catch{}
        // ocultar rating
        rate.style.display = "none";
        // refrescar tablero
        await loadUsage();
      };
    }

    // refrescar uso
    loadUsage();
  }catch(e){
    alert("Error en la consulta.");
  }
};

// primer render + refresco cada 15s
pingHealth();
loadUsage();
setInterval(loadUsage, 15000);
</script>
</body>
</html>
