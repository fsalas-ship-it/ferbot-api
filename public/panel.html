<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FerBot ¬∑ Panel</title>
<style>
  :root{
    --bg:#0b0f19; --panel:#0f1524; --ink:#e2e8f0; --muted:#94a3b8; --green:#97C93E;
    --ok:#19c37d; --warn:#fbbf24; --bad:#ef4444; --card:#0f1524CC;
  }
  html,body{background:var(--bg); color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0;}
  .wrap{max-width:860px;margin:24px auto;padding:0 12px}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px);}
  label{display:block;font-size:12px;color:#cbd5e1;margin:8px 0 4px}
  input,select,textarea{width:100%;background:#101727;color:var(--ink);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;font-size:14px;outline:none}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid; grid-template-columns:1fr 180px; gap:10px}
  .btns{display:flex; gap:8px; align-items:center; margin-top:12px}
  button{padding:10px 12px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
  .primary{background:var(--green); color:#0b0f19}
  .ghost{background:#1b2333;color:#cbd5e1}
  .good{background:#19c37d;color:#062d1f}
  .regular{background:#fbbf24;color:#332200}
  .bad{background:#ef4444;color:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#121a2b;border:1px solid rgba(255,255,255,.1);padding:4px 8px;border-radius:999px;font-size:12px;color:#cbd5e1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 10px">FerBot ‚Äî Panel</h2>
      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label>Contexto (opcional, para el bot)</label>
      <input id="context" placeholder="Notas breves‚Ä¶"/>

      <label>Texto del cliente</label>
      <textarea id="input" placeholder="Escribe el mensaje del cliente‚Ä¶"></textarea>

      <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
      <textarea id="guide" placeholder="Aqu√≠ ver√°s POR QU√â y el SIGUIENTE PASO‚Ä¶"></textarea>

      <label>Respuesta (lista para pegar)</label>
      <textarea id="output" placeholder="Se generar√° aqu√≠‚Ä¶"></textarea>

      <div class="btns">
        <button id="gen" class="primary">Generar</button>
        <button id="clear" class="ghost">Clear</button>
        <span id="timer" class="pill">0.0s</span>
        <span id="status" class="pill">Listo</span>
        <span style="flex:1"></span>
        <button id="rGood" class="good" style="display:none">üëç Buena</button>
        <button id="rReg"  class="regular" style="display:none">üòê Regular</button>
        <button id="rBad"  class="bad" style="display:none">üëé Mala</button>
      </div>
    </div>
  </div>

<script>
const BASE = (localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com").replace(/\/+$/,"");

// -------- Heartbeat usuarios activos --------
function getAgentId(){
  let id = localStorage.getItem("ferbot_agent_id");
  if (!id){ id = crypto.randomUUID(); localStorage.setItem("ferbot_agent_id", id); }
  return id;
}
async function heartbeat(){
  try{
    await fetch(BASE+"/trackUser", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ agentId:getAgentId(), source:"panel", userHint:"panel.html" })
    });
  }catch(_){}
}
heartbeat();
setInterval(heartbeat, 60*1000);

// -------- UI refs --------
const nameEl = document.getElementById("name");
const stageEl = document.getElementById("stage");
const ctxEl   = document.getElementById("context");
const inputEl = document.getElementById("input");
const guideEl = document.getElementById("guide");
const outEl   = document.getElementById("output");
const btnGen  = document.getElementById("gen");
const btnClr  = document.getElementById("clear");
const btnG    = document.getElementById("rGood");
const btnR    = document.getElementById("rReg");
const btnB    = document.getElementById("rBad");
const timerEl = document.getElementById("timer");
const statusEl= document.getElementById("status");

let t0=0, iv=null, lastReply=null;

function startTimer(){
  stopTimer();
  t0 = performance.now();
  iv = setInterval(()=>{
    const dt = (performance.now()-t0)/1000;
    timerEl.textContent = dt.toFixed(1)+"s";
  }, 80);
}
function stopTimer(){ if(iv){ clearInterval(iv); iv=null; } }

function guessIntent(q=""){
  const s = (q||"").toLowerCase();
  if (/(tiempo|no tengo tiempo|poco tiempo|agenda|horario|no alcanzo|ocupad)/.test(s)) return "tiempo";
  if (/(precio|caro|costo|costoso|vale|promoci|oferta|descuento)/.test(s)) return "precio";
  if (/(cert|certificado|certificaci√≥n|certificaciones)/.test(s)) return "cert";
  if (/(coursera|udemy|alura|competenc)/.test(s)) return "competencia";
  if (/(qu√© es platzi|que es platzi|platzi|pitch)/.test(s)) return "pitch";
  return "_panel";
}

function toggleRatings(show){
  btnG.style.display = show ? "inline-block":"none";
  btnR.style.display = show ? "inline-block":"none";
  btnB.style.display = show ? "inline-block":"none";
}

btnGen.onclick = async ()=>{
  const q = (inputEl.value||"").trim();
  if (!q){ alert("Escribe el mensaje del cliente."); return; }
  const name  = (nameEl.value||"").trim() || "Cliente";
  const stage = stageEl.value;
  const context = (ctxEl.value||"").trim();

  outEl.value = ""; guideEl.value = "";
  toggleRatings(false); lastReply = null; statusEl.textContent = "Generando‚Ä¶";
  startTimer();

  try{
    const res = await fetch(BASE+"/assist_trainer", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ question:q, customerName:name, stage, context, intent:guessIntent(q) })
    });
    stopTimer();
    if (!res.ok){
      const t = await res.text().catch(()=> "");
      alert("Error: "+t);
      statusEl.textContent = "Error";
      return;
    }
    const json = await res.json();
    const reply = (json?.result?.reply || json?.text || "").trim();
    const why   = (json?.result?.why  || "").trim();
    const next  = (json?.result?.next || "").trim();

    outEl.value  = reply;
    guideEl.value= `POR QU√â: ${why}\nSIGUIENTE PASO: ${next}`;
    statusEl.textContent = "Listo";
    lastReply = reply;
    toggleRatings(true);
  }catch(e){
    stopTimer();
    statusEl.textContent = "Error";
    alert("No se pudo generar. Verifica que el servidor est√© arriba.");
  }
};

btnClr.onclick = ()=>{
  outEl.value = ""; guideEl.value = "";
  toggleRatings(false); lastReply = null; stopTimer(); timerEl.textContent="0.0s";
};

async function sendRate(tag){
  if (!lastReply) return;
  try{
    await fetch(BASE+"/trackRate", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ intent: guessIntent(inputEl.value), stage: stageEl.value, text: lastReply, rating: tag })
    });
  }catch(_){}
  toggleRatings(false);
}
btnG.onclick = ()=> sendRate("good");
btnR.onclick = ()=> sendRate("regular");
btnB.onclick = ()=> sendRate("bad");
</script>
</body>
</html>
