<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FerBot ¬∑ Panel</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#0f1524; --muted:#94a3b8; --fg:#e2e8f0; --border:rgba(255,255,255,.08);
      --green:#97C93E; --red:#ef4444; --yellow:#f59e0b; --good:#19c37d;
    }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--fg); display:flex; align-items:center; justify-content:center; padding:24px}
    .wrap{width:min(900px,95vw)}
    .title{display:flex; align-items:center; gap:10px; margin-bottom:12px}
    .title .dot{width:10px;height:10px;border-radius:999px;background:var(--green);box-shadow:0 0 12px rgba(151,201,62,.6)}
    .sub{color:var(--muted); font-size:13px; margin-bottom:18px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:12px; color:var(--muted); margin-bottom:6px; display:block}
    input,select,textarea{width:100%; background:#0b1220; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px; font-size:14px; outline:none}
    textarea{min-height:100px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{padding:10px 14px; border:0; border-radius:10px; font-weight:700; cursor:pointer}
    .btn-primary{background:var(--green); color:#041106}
    .btn-ghost{background:#1b2333; color:#cbd5e1}
    .meter{display:flex; align-items:center; gap:10px}
    .bubble{min-width:64px; text-align:center; padding:6px 10px; border-radius:999px; font-weight:800; font-variant-numeric:tabular-nums; background:#111827; border:1px solid var(--border)}
    .bubble.red{color:#fff; background:var(--red)}
    .bubble.yellow{color:#231500; background:var(--yellow)}
    .bubble.green{color:#062d1f; background:var(--good)}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .result{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px}
    .foot{display:flex; gap:8px; margin-top:10px; align-items:center}
    .hidden{display:none !important}
    .love{margin-top:12px; color:var(--muted); font-size:12px}
    .love b{color:var(--green)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title"><div class="dot"></div><h2 style="margin:0">FerBot ¬∑ Panel de emergencia</h2></div>
    <div class="sub">Consulta r√°pida sin extensi√≥n. Usa el backend configurado en <code>localStorage.ferbot_api_base</code> o Render por defecto.</div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura">
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label>Contexto (opcional)</label>
          <input id="context" placeholder="Ej. solo 10 min/d√≠a; busca certificaci√≥n">
        </div>
        <div>
          <label>Mensaje del cliente</label>
          <input id="question" placeholder="Escribe la objeci√≥n o pega el texto seleccionado">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="go" class="btn btn-primary">Generar</button>
        <button id="clear" class="btn btn-ghost">Clear</button>

        <div class="meter">
          <span class="pill">Tiempo</span>
          <span id="timer" class="bubble">00.0s</span>
        </div>

        <div id="rated_once_helper" class="pill hidden">Calificado ‚úì</div>
      </div>

      <div class="result">
        <div>
          <label>Respuesta (para pegar)</label>
          <textarea id="reply" readonly placeholder="‚Äî"></textarea>
        </div>
        <div>
          <label>POR QU√â / SIGUIENTE PASO (para el asesor)</label>
          <textarea id="guide" readonly placeholder="‚Äî"></textarea>
        </div>
      </div>

      <div id="ratingRow" class="foot hidden">
        <span class="pill">¬øTe gust√≥ esta respuesta?</span>
        <button id="rGood" class="btn" style="background:#19c37d;color:#062d1f">üëç Buena</button>
        <button id="rRegular" class="btn" style="background:#fbbf24;color:#332200">üòê Regular</button>
        <button id="rBad" class="btn" style="background:#ef4444;color:#fff">üëé Mala</button>
      </div>

      <div class="love">Hecho con <b>amor</b> üíö</div>
    </div>
  </div>

  <script>
    // ====== BASE del backend ======
    const BASE = localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com";

    // ====== Refs
    const el = (id)=> document.getElementById(id);
    const nameEl   = el("name");
    const stageEl  = el("stage");
    const ctxEl    = el("context");
    const qEl      = el("question");
    const goBtn    = el("go");
    const clearBtn = el("clear");
    const timerEl  = el("timer");
    const replyEl  = el("reply");
    const guideEl  = el("guide");
    const ratingRow= el("ratingRow");
    const rGood    = el("rGood");
    const rRegular = el("rRegular");
    const rBad     = el("rBad");
    const ratedOnceHelper = el("rated_once_helper");

    // ====== Countdown (color y segundos)
    let t0=0, tid=null;
    function startTimer(){
      stopTimer();
      t0 = performance.now();
      timerEl.classList.remove("green","yellow"); // arranca "rojo" por CSS base
      timerEl.classList.add("red");
      tid = setInterval(()=>{
        const s = (performance.now()-t0)/1000;
        timerEl.textContent = s.toFixed(1)+"s";
        // Colores aproximados por tiempo
        if (s >= 1.5 && s < 3) {
          timerEl.classList.remove("red","green");
          timerEl.classList.add("yellow");
        } else if (s >= 3) {
          timerEl.classList.remove("red","yellow");
          timerEl.classList.add("green");
        }
      }, 100);
    }
    function stopTimer(){
      if (tid) clearInterval(tid);
      tid=null;
    }
    function markDone(){
      stopTimer();
      const s = (performance.now()-t0)/1000;
      timerEl.textContent = s.toFixed(1)+"s";
      timerEl.classList.remove("red","yellow");
      timerEl.classList.add("green");
    }

    function sanitize(s){ return String(s||"").replace(/\s+/g," ").trim(); }

    // ====== Llamada principal
    goBtn.onclick = async () => {
      const question = sanitize(qEl.value);
      if (!question){ alert("Escribe el mensaje/objeci√≥n del cliente"); qEl.focus(); return; }

      replyEl.value = ""; guideEl.value = "";
      ratingRow.classList.add("hidden");
      ratedOnceHelper.classList.add("hidden");

      startTimer();
      try{
        const res = await fetch(BASE + "/assist_trainer", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            question,
            customerName: sanitize(nameEl.value) || "Cliente",
            stage: stageEl.value,
            context: sanitize(ctxEl.value)
          })
        });
        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          alert("No se pudo generar (HTTP "+res.status+"). " + txt);
          markDone();
          return;
        }
        const json = await res.json();

        const reply = (json?.result?.reply || json?.text || "").trim();
        const why   = (json?.result?.why   || "").trim();
        const next  = (json?.result?.next  || "").trim();

        replyEl.value = reply || "‚Äî";
        guideEl.value = `POR QU√â: ${why || "-"}\nSIGUIENTE PASO: ${next || "-"}`;

        // mostrar rating UNA sola vez por respuesta
        ratingRow.classList.remove("hidden");

      }catch(e){
        alert("No se pudo generar. ¬øAPI vigente?");
      }finally{
        markDone();
      }
    };

    // ====== Clear
    clearBtn.onclick = () => {
      replyEl.value = "";
      guideEl.value = "";
      ratingRow.classList.add("hidden");
      ratedOnceHelper.classList.add("hidden");
      timerEl.textContent = "00.0s";
      timerEl.classList.remove("red","yellow","green");
    };

    // ====== Rating (se oculta despu√©s de enviar)
    async function sendRating(rating){
      const utter = sanitize(replyEl.value);
      if(!utter) return;
      try{
        await fetch(BASE + "/trackRate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            intent: "_panel_",
            stage: stageEl.value,
            text: utter,
            rating
          })
        });
      }catch(_){}
      ratingRow.classList.add("hidden");
      ratedOnceHelper.classList.remove("hidden");
    }
    rGood.onclick    = ()=> sendRating("good");
    rRegular.onclick = ()=> sendRating("regular");
    rBad.onclick     = ()=> sendRating("bad");
  </script>
</body>
</html>
