<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ¬∑ Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --green:#97C93E; --dark:#0b0f19; --panel:#0b0f19CC; --ink:#e2e8f0; --muted:#94a3b8;
      --ok:#19c37d; --warn:#f59e0b; --bad:#ef4444; --card:#0f1524; --line:rgba(255,255,255,.08);
      --chip:#101727;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--dark);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border:1px solid var(--line);background:#0c1322;border-radius:12px;cursor:pointer;font-weight:700}
    .tab.active{background:var(--card);border-color:var(--line)}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid-2{grid-template-columns: 1.1fr .9fr } }
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select,textarea{width:100%;background:#0c1322;border:1px solid var(--line);color:#dbeafe;border-radius:10px;padding:9px;font-size:14px;outline:none}
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:0;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#131c2c;color:#cbd5e1}
    .good{background:var(--ok);color:#062d1f;display:none}
    .reg{background:#fbbf24;color:#332200;display:none}
    .bad{background:var(--bad);color:#fff;display:none}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:6px 10px;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#64748b}
    .dot.pos{background:var(--ok)} .dot.neu{background:var(--warn)} .dot.neg{background:var(--bad)}
    .signal{display:inline-flex;align-items:center;gap:8px}
    .bullet{width:10px;height:10px;border-radius:999px;background:var(--bad)}
    .bullet.amber{background:var(--warn)} .bullet.green{background:var(--ok)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi .n{font-size:22px;font-weight:900}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left}
    th{color:#9fb3d1}
    .hint{font-size:12px;color:var(--muted)}
    .tabsline{margin:12px 0;border-top:1px dashed var(--line)}
    .center{display:flex;justify-content:center;align-items:center}
    canvas{width:100%;height:260px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FerBot ¬∑ Panel <span class="hint">‚ö°</span></h1>
      <div class="tabs">
        <div class="tab active" data-tab="asistente">Asistente</div>
        <div class="tab" data-tab="usabilidad">Usabilidad</div>
      </div>
    </header>

    <!-- ============ TABS ============ -->
    <section id="tab-asistente">
      <div class="grid grid-2">
        <!-- L: Asistente -->
        <div class="card">
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <div class="row">
              <div class="pill"><span>FerBot</span> ü§ñ</div>
            </div>
            <div class="signal">
              <span class="bullet" id="bullett"></span>
              <span class="pill"><strong id="timer">0.0s</strong></span>
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label>Nombre del cliente</label>
              <input id="name" placeholder="Ej. Laura"/>
            </div>
            <div style="width:46%">
              <label>Etapa</label>
              <select id="stage">
                <option value="integracion">Integraci√≥n</option>
                <option value="sondeo">Sondeo</option>
                <option value="pre_cierre">Pre-cierre</option>
                <option value="rebatir" selected>Rebatir</option>
                <option value="cierre">Cierre</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Contexto (opcional, para el bot)</label>
            <input id="context" placeholder="Ej. certificaciones; poco tiempo; habl√≥ de ingl√©s‚Ä¶"/>
          </div>

          <div class="row" style="justify-content:space-between;margin-top:10px">
            <label class="muted">Selecciona texto del chat o escribe la objeci√≥n, luego <b>Generar</b>.</label>
            <label class="muted row" style="gap:6px"><input type="checkbox" id="autopaste"/> Autopaste</label>
          </div>

          <div class="row" style="align-items:flex-end;margin-top:6px">
            <div class="grow">
              <textarea id="input" placeholder="Texto / objeci√≥n del cliente‚Ä¶"></textarea>
            </div>
            <div class="pill" id="sent-pill" title="Sentimiento">
              <span class="dot neu" id="sent-dot"></span><span id="sent-txt">Neutral</span>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
            <textarea id="guide" placeholder="Aqu√≠ ver√°s POR QU√â y el SIGUIENTE PASO para ense√±ar al asesor."></textarea>
          </div>

          <div style="margin-top:10px">
            <label>Respuesta (lista para pegar)</label>
            <textarea id="output" placeholder="Mensaje breve para el cliente (m√°x 2 frases)‚Ä¶"></textarea>
          </div>

          <div class="btns" style="margin-top:10px">
            <button class="primary" id="btn-gen">Generar</button>
            <button class="ghost" id="btn-clear">Clear</button>
            <button class="good" id="btn-good">üëç Buena</button>
            <button class="reg" id="btn-reg">üòê Regular</button>
            <button class="bad" id="btn-bad">üëé Mala</button>
          </div>

          <div class="hint" style="margin-top:10px">Hecho con amor <span style="color:var(--green)">‚ô•</span></div>
        </div>

        <!-- R: Estado API + Ayuda corta -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0;font-size:15px">Estado</h3>
            <div class="pill" id="health-pill">api: ‚Äî</div>
          </div>
          <div style="margin-top:12px">
            <div class="hint">BASE: <code id="base-show"></code></div>
            <div class="hint">Si algo falla, prueba /health y revisa la consola.</div>
            <div class="tabsline"></div>
            <div class="hint">Consejo: autocompleta el ‚ÄúNombre del cliente‚Äù y usa Autopaste si quieres pegar directo en el chat.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-usabilidad" style="display:none">
      <div class="kpis" style="margin-bottom:12px">
        <div class="kpi"><div class="muted">Respuestas mostradas</div><div class="n" id="k-shown">0</div></div>
        <div class="kpi"><div class="muted">Winrate compuesto</div><div class="n" id="k-win">0%</div></div>
        <div class="kpi"><div class="muted">üëç Buenas</div><div class="n" id="k-good">0</div></div>
        <div class="kpi"><div class="muted">üëé Malas</div><div class="n" id="k-bad">0</div></div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <div class="muted">Por etapa</div>
            <div class="hint">aprox √∫ltimos minutos (estimado por delta)</div>
          </div>
          <canvas id="donut-stage" width="480" height="260"></canvas>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <div class="muted">Por intento</div>
            <div class="hint">aprox √∫ltimos minutos (estimado por delta)</div>
          </div>
          <canvas id="donut-intent" width="480" height="260"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div class="muted">Top respuestas (efectivas)</div>
          <div class="row" style="gap:8px">
            <div class="pill">Activos ~5m: <b id="act-5m">0</b></div>
            <div class="pill">Activos hoy: <b id="act-day">0</b></div>
            <div class="pill">Auto-refresh 5s</div>
          </div>
        </div>
        <div class="table">
          <table>
            <thead><tr><th>Intent</th><th>Stage</th><th>Texto</th><th>Shown</th><th>Wins</th><th>Winrate</th></tr></thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // =========================
    // CONFIG BASE
    // =========================
    // Si corre servido desde Render, usamos origin. Si no, permite override por localStorage.
    const defaultBase = location.origin;
    const lsBase = localStorage.getItem("ferbot_api_base");
    const BASE = (lsBase && /^https?:\/\//.test(lsBase)) ? lsBase : defaultBase;

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    $("#base-show").textContent = BASE;

    // =========================
    // TABS
    // =========================
    $$(".tab").forEach(t=>{
      t.onclick = () => {
        $$(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        const id = t.dataset.tab;
        $("#tab-asistente").style.display = (id==="asistente")?"block":"none";
        $("#tab-usabilidad").style.display = (id==="usabilidad")?"block":"none";
      };
    });

    // =========================
    // HEALTH
    // =========================
    async function pingHealth(){
      try{
        const r = await fetch(`${BASE}/health`, {cache:"no-store"});
        const j = await r.json();
        $("#health-pill").textContent = j.ok ? `api: ok ‚Ä¢ ${j.model_env || ""}` : "api: error";
      }catch{
        $("#health-pill").textContent = "api: error";
      }
    }
    pingHealth();

    // =========================
    // SENTIMIENTO HEUR√çSTICO
    // =========================
    function updSent(text){
      const s = (text||"").toLowerCase();
      const neg = /(no puedo|caro|dif√≠cil|malo|no sirve|no tengo tiempo|no s√©|no se)/i;
      const pos = /(gracias|me interesa|genial|perfecto|bien|listo|buen√≠simo)/i;
      const dot = $("#sent-dot"), txt = $("#sent-txt");
      if (neg.test(s)){ dot.className="dot neg"; txt.textContent="Negativo"; }
      else if (pos.test(s)){ dot.className="dot pos"; txt.textContent="Positivo"; }
      else { dot.className="dot neu"; txt.textContent="Neutral"; }
    }

    $("#input").addEventListener("input", e=>updSent(e.target.value));
    document.addEventListener("selectionchange", ()=>{
      const sel = window.getSelection()?.toString()?.trim() || "";
      if(sel){ $("#input").value = sel; updSent(sel); }
    });

    // =========================
    // COUNTDOWN
    // =========================
    let t0=0, iv=null;
    function startTimer(){
      stopTimer();
      t0 = performance.now();
      setBullet("red");
      iv = setInterval(()=>{
        const dt = (performance.now()-t0)/1000;
        $("#timer").textContent = dt.toFixed(1)+"s";
        if (dt < 2) setBullet("red");
        else if (dt < 4) setBullet("amber");
        else setBullet("green");
      }, 100);
    }
    function stopTimer(){ if(iv){ clearInterval(iv); iv=null; } }
    function setBullet(color){
      const b=$("#bullett");
      b.classList.remove("amber","green");
      if (color==="amber") b.classList.add("amber");
      else if (color==="green") b.classList.add("green");
    }

    // =========================
    // INTENT GUESS
    // =========================
    function guessIntent(q=""){
      const s=(q||"").toLowerCase();
      if (/(tiempo|no tengo tiempo|poco tiempo|agenda|horario|ocupad)/.test(s)) return "tiempo";
      if (/(precio|caro|costo|vale|descuento|oferta|promoci)/.test(s)) return "precio";
      if (/(cert|certificado|certificaci√≥n)/.test(s)) return "cert";
      if (/(coursera|udemy|alura|competenc)/.test(s)) return "competencia";
      if (/(pitch|qu√© es platzi|que es platzi|platzi)/.test(s)) return "pitch";
      return "_default";
    }

    // =========================
    // AUTOPASTE UTIL
    // =========================
    function isInside(el, sel){ return !!(el && el.closest && el.closest(sel)); }
    function isWrite(el){
      if (!el) return false;
      if (el.isContentEditable) return true;
      const t=(el.tagName||"").toLowerCase();
      if (t==="textarea") return true;
      if (t==="input"){ const tp=(el.type||"text").toLowerCase(); return tp==="text"||tp==="search"; }
      return false;
    }
    function writeTo(el,text){
      try{
        el.focus();
        if (el.isContentEditable){
          while(el.firstChild) el.removeChild(el.firstChild);
          el.appendChild(document.createTextNode(text));
        } else {
          el.value = text;
        }
        try{ document.execCommand("insertText", false, text); }catch{}
        el.dispatchEvent(new InputEvent("input",{bubbles:true}));
        el.dispatchEvent(new Event("change",{bubbles:true}));
        el.dispatchEvent(new Event("keyup",{bubbles:true}));
      }catch{}
    }
    function autopaste(text){
      if (!$("#autopaste").checked) return;
      const f=document.activeElement;
      if (f && isWrite(f) && !isInside(f,".wrap")) { writeTo(f,text); return; }
      const ed = Array.from(document.querySelectorAll('div[contenteditable="true"],[role="textbox"]'))
        .filter(n=>n.offsetParent!==null && !isInside(n,".wrap"));
      for (const el of ed){ writeTo(el,text); return; }
      const tas = Array.from(document.querySelectorAll('textarea')).filter(n=>n.offsetParent!==null && !isInside(n,".wrap"));
      for (const el of tas){ writeTo(el,text); return; }
      const ins = Array.from(document.querySelectorAll('input[type="text"],input:not([type])')).filter(n=>n.offsetParent!==null && !isInside(n,".wrap"));
      for (const el of ins){ writeTo(el,text); return; }
    }

    // =========================
    // GENERAR
    // =========================
    let lastReply=null;

    $("#btn-gen").onclick = async () => {
      const q = ($("#input").value||"").trim() || (window.getSelection()?.toString()?.trim()||"");
      if (!q){ alert("Escribe la objeci√≥n/pregunta primero."); return; }
      const name = ($("#name").value||"").trim() || "Cliente";
      const stage= $("#stage").value;
      const context = ($("#context").value||"").trim();

      // limpiar y preparar
      $("#guide").value=""; $("#output").value="";
      showRatings(false);
      startTimer();

      try{
        const body = { question:q, customerName:name, stage, context, intent: guessIntent(q) };
        const r = await fetch(`${BASE}/assist_trainer`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });

        stopTimer(); setBullet("green");

        if(!r.ok){
          const t = await r.text().catch(()=> "");
          alert(`No se pudo generar (HTTP ${r.status}). ${t || ""}`);
          return;
        }
        const j = await r.json();
        const reply = (j?.result?.reply || j?.text || "").trim();
        const why   = (j?.result?.why  || "").trim();
        const next  = (j?.result?.next || "").trim();

        $("#output").value = reply;
        $("#guide").value  = `POR QU√â: ${why}\nSIGUIENTE PASO: ${next}`;
        lastReply = reply;

        autopaste(reply);
        showRatings(true);

        // engancha handlers de rating 1-vez
        $("#btn-good").onclick = () => rate("good", reply, stage, q);
        $("#btn-reg").onclick  = () => rate("regular", reply, stage, q);
        $("#btn-bad").onclick  = () => rate("bad", reply, stage, q);
      }catch(e){
        stopTimer();
        alert("No se pudo generar. ¬øServidor arriba? Revisa /health.");
      }
    };

    $("#btn-clear").onclick = ()=>{
      $("#guide").value=""; $("#output").value="";
      showRatings(false); stopTimer(); $("#timer").textContent="0.0s"; setBullet("red");
    };

    function showRatings(show){
      $("#btn-good").style.display = show ? "inline-block":"none";
      $("#btn-reg").style.display  = show ? "inline-block":"none";
      $("#btn-bad").style.display  = show ? "inline-block":"none";
    }

    async function rate(kind, text, stage, userText){
      try{
        await fetch(`${BASE}/trackRate`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ intent: guessIntent(userText), stage, text, rating: kind })
        });
      }catch{}
      showRatings(false);
      // refrescar usabilidad ‚Äúa mano‚Äù por si est√° abierta
      try{ await refreshStats(); }catch{}
    }

    // =========================
    // USABILIDAD (cliente)
    // =========================
    let snapshot=null, lastShown=0, lastShownTime=Date.now();

    async function getStats(){
      const r = await fetch(`${BASE}/stats`, {cache:"no-store"});
      const j = await r.json();
      return Array.isArray(j?.rows) ? j.rows : [];
    }

    function aggregate(rows){
      const sum = rows.reduce((a,x)=>a + Number(x.shown||0), 0);
      const wins = rows.reduce((a,x)=>a + Number(x.wins||0), 0);
      const good = rows.reduce((a,x)=>a + Number(x.good||0), 0);
      const bad  = rows.reduce((a,x)=>a + Number(x.bad||0), 0);
      // por etapa / intento
      const byStage={}, byIntent={};
      rows.forEach(r=>{
        byStage[r.stage] = (byStage[r.stage]||0) + Number(r.shown||0);
        byIntent[r.intent]= (byIntent[r.intent]||0)+ Number(r.shown||0);
      });
      return {sum,wins,good,bad,byStage,byIntent};
    }

    function drawDonut(canvas, dataMap){
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const entries = Object.entries(dataMap).filter(([k,v])=>v>0);
      const total = entries.reduce((a,[,v])=>a+v,0) || 1;
      let start = -Math.PI/2;
      const cx=canvas.width/2, cy=canvas.height/2, R=Math.min(cx,cy)-10, r=R*0.58;
      // borde
      ctx.lineWidth = 2; ctx.strokeStyle="#fff2";
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();
      // sectores
      entries.forEach(([,v],i)=>{
        const ang = (v/total)*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,R,start,start+ang);
        ctx.closePath();
        ctx.fillStyle = `hsl(${(i*57)%360} 60% 50% / .9)`;
        ctx.fill();
        start += ang;
      });
      // agujero
      ctx.globalCompositeOperation="destination-out";
      ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation="source-over";
    }

    function fillRows(rows){
      // Ordena por winrate desc y exposici√≥n
      const sorted = [...rows].sort((a,b)=> (b.winrate - a.winrate) || (b.shown - a.shown));
      const tbody = $("#rows"); tbody.innerHTML="";
      sorted.slice(0,50).forEach(r=>{
        const tr = document.createElement("tr");
        const wr = ((Number(r.winrate||0))*100).toFixed(1)+"%";
        tr.innerHTML = `<td>${r.intent}</td><td>${r.stage}</td><td>${escapeHtml(r.text)}</td>
                        <td>${r.shown}</td><td>${r.wins}</td><td>${wr}</td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s=""){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}

    async function refreshStats(){
      const rows = await getStats();
      const agg = aggregate(rows);

      // KPIs
      $("#k-shown").textContent = agg.sum;
      const winrate = agg.sum>0 ? ((agg.wins/agg.sum)*100).toFixed(1) : "0.0";
      $("#k-win").textContent = `${winrate}%`;
      $("#k-good").textContent = agg.good;
      $("#k-bad").textContent  = agg.bad;

      // Donuts
      drawDonut($("#donut-stage"), agg.byStage);
      drawDonut($("#donut-intent"), agg.byIntent);

      // Tabla
      fillRows(rows);

      // Activos aprox (por delta desde la √∫ltima lectura)
      if (snapshot){
        const deltaShown = agg.sum - lastShown;
        const minutes = Math.max((Date.now()-lastShownTime)/60000, 0.1);
        const act5 = Math.max(0, Math.round(deltaShown / Math.max(minutes/5, 0.2)));
        $("#act-5m").textContent = act5;
        $("#act-day").textContent = new Date().toLocaleDateString();
      }
      snapshot = agg; lastShown = agg.sum; lastShownTime = Date.now();
    }

    // Primer fetch inmediato y luego cada 5s (cuando la pesta√±a ‚ÄúUsabilidad‚Äù est√© visible)
    refreshStats();
    setInterval(()=>{ if ($("#tab-usabilidad").style.display!=="none") refreshStats(); }, 5000);

  </script>
</body>
</html>
