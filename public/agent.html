<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FerBot ¬∑ Panel</title>
  <style>
    :root{--bg:#0b0f19;--card:#0f1524;--text:#e2e8f0;--muted:#94a3b8;--platzi:#97C93E;--ok:#19c37d;--warn:#fbbf24;--bad:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .shell{max-width:780px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:20px} .sub{color:var(--muted);font-size:13px;margin-bottom:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input,textarea,select{width:100%;background:#0e1322;color:#dbeafe;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;gap:8px;margin-top:12px}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 12px;font-weight:700}
    .primary{background:var(--platzi);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .rate{display:none;gap:6px;margin-top:10px}
    .good{background:var(--ok);color:#062d1f} .regular{background:var(--warn);color:#332200} .bad{background:var(--bad);color:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    .whyNext{white-space:pre-wrap}
    .bar{height:8px;border-radius:999px;background:#1b2333;overflow:hidden;position:relative;margin:8px 0}
    .bar>i{position:absolute;left:0;top:0;bottom:0;width:0%;background:var(--bad);transition:width .2s linear, background .2s linear}
    .timer{font-size:12px;color:var(--muted)}
    .sentiment{font-size:12px;padding:6px 8px;border-radius:999px;display:inline-flex;align-items:center;gap:6px}
    .s-neg{background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .s-neu{background:rgba(251,191,36,.12);color:#fde68a;border:1px solid rgba(251,191,36,.35)}
    .s-pos{background:rgba(25,195,125,.14);color:#bbf7d0;border:1px solid rgba(25,195,125,.35)}
    .footer{margin-top:12px;color:var(--muted);font-size:12px;display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--platzi);box-shadow:0 0 0 0 rgba(151,201,62,.8);animation:pulse 1.5s infinite}
    @keyframes pulse{to{box-shadow:0 0 0 12px rgba(151,201,62,0)}}
  </style>
</head>
<body>
  <div class="shell">
    <h1>FerBot ¬∑ Panel</h1>
    <div class="sub">Consulta r√°pida cuando no tengas la extensi√≥n. Usa el mismo motor que Hilos.</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label style="margin-top:6px">Contexto (opcional)</label>
      <input id="ctx" placeholder="Ej. trabaja tiempo completo; busca certificaci√≥n"/>

      <label style="margin-top:6px">Texto/objeci√≥n del cliente</label>
      <textarea id="input" placeholder="Copia aqu√≠ lo que dijo el cliente‚Ä¶"></textarea>

      <div id="sentWrap" style="margin-top:8px;display:none"></div>

      <div class="bar" title="Tiempo de respuesta"><i id="bar"></i></div>
      <div class="timer" id="timer">0.0 s</div>

      <div class="btns">
        <button id="go" class="primary">Generar</button>
        <button id="clear" class="ghost">Clear</button>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label>Respuesta (para pegar)</label>
          <textarea id="out" class="mono" placeholder="Aqu√≠ sale el mensaje listo para WhatsApp‚Ä¶"></textarea>
        </div>
        <div>
          <label>POR QU√â + SIGUIENTE PASO (para el asesor)</label>
          <textarea id="why" class="mono whyNext" placeholder="Motivo de la respuesta y acci√≥n siguiente‚Ä¶"></textarea>
        </div>
      </div>

      <div id="rate" class="rate">
        <button id="rGood" class="good">üëç Buena</button>
        <button id="rReg" class="regular">üòê Regular</button>
        <button id="rBad" class="bad">üëé Mala</button>
      </div>

      <div class="footer">
        <div class="dot"></div>
        <div>Hecho con amor <span style="color:#97C93E">üíö</span></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const BASE = localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com";

  const el = id => document.getElementById(id);
  const nameEl = el("name"), stageEl = el("stage"), ctxEl = el("ctx"), inputEl = el("input");
  const outEl = el("out"), whyEl = el("why"), rateBox = el("rate");
  const bGo = el("go"), bClear = el("clear");
  const bGood = el("rGood"), bReg = el("rReg"), bBad = el("rBad");
  const bar = el("bar"), timer = el("timer"), sentWrap = el("sentWrap");

  // Sentiment muy simple (local)
  function sentiment(s=""){
    const t = s.toLowerCase();
    if (/(no tengo tiempo|caro|no puedo|dudo|miedo|no sirve|cancelar)/.test(t)) return { tag:"negativo", cls:"s-neg", tip:"Valida emoci√≥n y propone micro-acci√≥n." };
    if (/(gracias|bien|perfecto|me gusta|suena bien)/.test(t)) return { tag:"positivo", cls:"s-pos", tip:"Aprovecha el momentum con CTA corto." };
    return { tag:"neutral", cls:"s-neu", tip:"Aterriza meta y ofrece primer paso." };
  }

  function showSentiment(){
    const s = inputEl.value.trim();
    if (!s){ sentWrap.style.display="none"; sentWrap.innerHTML=""; return; }
    const res = sentiment(s);
    sentWrap.style.display="block";
    sentWrap.innerHTML = `<span class="sentiment ${res.cls}">Estado: <b>${res.tag}</b> ¬∑ ${res.tip}</span>`;
  }

  // Countdown/barra
  let t0=0, ti=null;
  function startTimer(){
    t0 = performance.now();
    bar.style.width = "10%";
    bar.style.background = "var(--bad)";
    timer.textContent = "0.0 s";
    clearInterval(ti);
    ti = setInterval(()=>{
      const dt = (performance.now()-t0)/1000;
      timer.textContent = dt.toFixed(1)+" s";
      const pct = Math.min(95, 10 + dt*15); // crece suave hasta 95%
      bar.style.width = pct+"%";
      if (dt>3) bar.style.background = "var(--warn)";
    }, 120);
  }
  function stopTimerOK(){
    clearInterval(ti);
    const dt = (performance.now()-t0)/1000;
    timer.textContent = dt.toFixed(1)+" s";
    bar.style.width = "100%";
    bar.style.background = "var(--ok)";
  }

  async function generate(){
    const question = inputEl.value.trim();
    if (!question){ alert("Escribe o pega el mensaje del cliente."); return; }

    showSentiment();
    rateBox.style.display = "none";
    outEl.value = ""; whyEl.value = "";
    startTimer();

    const payload = {
      question,
      customerName: (nameEl.value || "Cliente").trim(),
      stage: stageEl.value,
      context: ctxEl.value.trim() || ""
    };

    try{
      const r = await fetch(`${BASE}/assist_trainer`, {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
      });
      if (!r.ok){
        const tx = await r.text().catch(()=> "");
        alert(`Error ${r.status}: ${tx.slice(0,200)}`);
        return;
      }
      const json = await r.json();
      const reply = (json?.result?.reply || json?.text || "").trim();
      const why   = (json?.result?.why   || "").trim();
      const next  = (json?.result?.next  || "").trim();

      outEl.value = reply || "(sin respuesta)";
      const combo = `POR QU√â: ${why || "-"}\nSIGUIENTE PASO: ${next || "-"}`;
      whyEl.value = combo;

      // mostrar rating (1 sola vez por respuesta)
      rateBox.style.display = "flex";
      rateBox.dataset.hash = btoa(unescape(encodeURIComponent((reply||"").slice(0,240))));
      stopTimerOK();
    }catch(e){
      alert("No se pudo generar. ¬øAPI vigente?");
      console.error(e);
    }
  }

  async function rate(kind){
    if (rateBox.style.display==="none") return;
    const reply = outEl.value.trim(); if (!reply) return;
    const hash = rateBox.dataset.hash || "";
    const already = sessionStorage.getItem("rated:"+hash);
    if (already) { rateBox.style.display="none"; return; } // evita doble rating

    try{
      await fetch(`${BASE}/trackRate`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          intent: "_panel", stage: stageEl.value, text: reply, rating: kind
        })
      });
    }catch(_){}
    sessionStorage.setItem("rated:"+hash, "1");
    rateBox.style.display = "none";
  }

  // Eventos
  bGo.addEventListener("click", generate);
  bClear.addEventListener("click", ()=>{ outEl.value=""; whyEl.value=""; rateBox.style.display="none"; });
  inputEl.addEventListener("input", showSentiment);
  bGood.addEventListener("click", ()=>rate("good"));
  bReg.addEventListener("click",  ()=>rate("regular"));
  bBad.addEventListener("click",  ()=>rate("bad"));

  // Prefills leves desde localStorage
  nameEl.value = localStorage.getItem("ferbot_name") || "";
  nameEl.addEventListener("change", ()=> localStorage.setItem("ferbot_name", nameEl.value.trim()));
})();
</script>
</body>
</html>
