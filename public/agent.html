<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>FerBot Â· Panel unificado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/panel.css" />
</head>
<body>
  <div class="wrap">
    <h1>FerBot Â· Panel unificado</h1>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div class="pill">
          <span class="dot" id="healthDot"></span>
          <span id="healthText">Revisando APIâ€¦</span>
        </div>
        <div class="pill"><span class="timer" id="timer">0.0s</span></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="row">
          <div>
            <label>Nombre del cliente</label>
            <input id="name" placeholder="Ej. Laura"/>
          </div>
          <div>
            <label>Etapa</label>
            <select id="stage">
              <option value="integracion">IntegraciÃ³n</option>
              <option value="sondeo" selected>Sondeo</option>
              <option value="rebatir">Rebatir</option>
              <option value="pre_cierre">Pre-cierre</option>
              <option value="cierre">Cierre</option>
            </select>
          </div>
        </div>

        <label>Contexto (opcional, para el bot)</label>
        <input id="context" placeholder="Ej. preguntÃ³ por certificaciones; poco tiempo" />

        <label style="margin-top:8px">Texto del cliente</label>
        <textarea id="question" placeholder="Escribe la objeciÃ³n/preguntaâ€¦"></textarea>

        <label style="margin-top:8px">ExplicaciÃ³n (POR QUÃ‰ + SIGUIENTE PASO)</label>
        <textarea id="guide" readonly placeholder="AquÃ­ verÃ¡s POR QUÃ‰ y el SIGUIENTE PASO."></textarea>

        <label style="margin-top:8px">Respuesta (lista para pegar)</label>
        <textarea id="reply" readonly placeholder="Mensaje breve para el cliente (â‰¤ 2 frases)."></textarea>

        <div class="btns">
          <button class="btn primary" id="generate">Generar</button>
          <button class="btn ghost" id="clear">Clear</button>
          <button class="btn" id="good" style="background:#19c37d;color:#062d1f;display:none">ğŸ‘ Buena</button>
          <button class="btn" id="regular" style="background:#fbbf24;color:#332200;display:none">ğŸ˜ Regular</button>
          <button class="btn" id="bad" style="background:#ef4444;color:#fff;display:none">ğŸ‘ Mala</button>
        </div>
      </div>

      <div class="card">
        <label>Sentimiento del cliente</label>
        <div class="pill" id="sentBadge"><span class="dot neu" id="sentDot"></span><span id="sentText">Neutral</span></div>

        <div style="margin-top:16px">
          <label>Logs / estado</label>
          <textarea id="logs" readonly style="min-height:220px"></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
const BASE = location.origin; // mismo servidor
const healthDot = document.getElementById('healthDot');
const healthText = document.getElementById('healthText');

const nameEl = document.getElementById('name');
const stageEl = document.getElementById('stage');
const ctxEl = document.getElementById('context');
const qEl = document.getElementById('question');
const guideEl = document.getElementById('guide');
const replyEl = document.getElementById('reply');
const logEl = document.getElementById('logs');

const btnGen = document.getElementById('generate');
const btnClear = document.getElementById('clear');
const btnGood = document.getElementById('good');
const btnReg = document.getElementById('regular');
const btnBad = document.getElementById('bad');

const timerEl = document.getElementById('timer');
let t0=0, iv=null;

function startTimer(){
  stopTimer(); t0 = performance.now();
  iv = setInterval(()=>{ timerEl.textContent = ((performance.now()-t0)/1000).toFixed(1)+'s'; }, 100);
}
function stopTimer(){ if(iv){ clearInterval(iv); iv=null; } }

async function checkHealth(){
  try{
    const r = await fetch(BASE + '/health'); const j = await r.json();
    healthText.textContent = j.ok ? `API OK (${j.model_env})` : 'Error API';
    healthDot.className = 'dot ' + (j.ok ? 'pos': 'neg');
  }catch{ healthText.textContent = 'Sin conexiÃ³n'; healthDot.className = 'dot neg'; }
}
checkHealth();

function setSent(s) {
  const dot = document.getElementById('sentDot');
  const txt = document.getElementById('sentText');
  dot.classList.remove('pos','neu','neg'); dot.classList.add(s.cls);
  txt.textContent = s.text;
}
function analyzeSent(t) {
  t = (t||'').toLowerCase();
  const neg = /(no puedo|caro|difÃ­cil|malo|no tengo tiempo|no sirve|no sÃ©|no se)/i;
  const pos = /(gracias|excelente|me interesa|bien|listo|perfecto|genial)/i;
  if (neg.test(t)) return {cls:'neg', text:'Negativo'};
  if (pos.test(t)) return {cls:'pos', text:'Positivo'};
  return {cls:'neu', text:'Neutral'};
}
qEl.addEventListener('input', ()=> setSent(analyzeSent(qEl.value)));

function toggleRatings(show){
  btnGood.style.display = show ? 'inline-block':'none';
  btnReg.style.display  = show ? 'inline-block':'none';
  btnBad.style.display  = show ? 'inline-block':'none';
}
toggleRatings(false);

btnGen.onclick = async () => {
  const q = (qEl.value||'').trim();
  if (!q){ alert('Escribe el texto del cliente.'); return; }
  guideEl.value = ''; replyEl.value = ''; toggleRatings(false);
  startTimer();
  try{
    const body = { question:q, customerName:(nameEl.value||'Cliente'), stage:stageEl.value, context:(ctxEl.value||'') };
    const r = await fetch(BASE + '/assist_trainer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    stopTimer();
    if (!r.ok){ const t = await r.text(); alert('Error '+r.status+': '+t); return; }
    const j = await r.json();
    replyEl.value = j?.result?.reply || j?.text || '';
    guideEl.value = `POR QUÃ‰: ${(j?.result?.why||'')}\nSIGUIENTE PASO: ${(j?.result?.next||'')}`;
    logEl.value = JSON.stringify(j, null, 2);
    toggleRatings(true);
  }catch(e){
    stopTimer(); alert('No se pudo conectar al servidor.'); console.error(e);
  }
};

btnClear.onclick = ()=>{ guideEl.value=''; replyEl.value=''; toggleRatings(false); stopTimer(); timerEl.textContent='0.0s'; };

async function rate(type){
  const text = (replyEl.value||'').trim();
  if (!text) return;
  try{
    await fetch(BASE + '/trackRate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ intent:'_panel', stage:stageEl.value, text, rating:type }) });
  }catch{} toggleRatings(false);
}
btnGood.onclick = ()=> rate('good');
btnReg.onclick  = ()=> rate('regular');
btnBad.onclick  = ()=> rate('bad');
</script>
</body>
</html>
