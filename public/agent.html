<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ¬∑ Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --green:#97C93E; --dark:#0b0f19; --panel:#0b0f19CC; --ink:#e2e8f0; --muted:#94a3b8;
      --ok:#19c37d; --warn:#fbbf24; --bad:#ef4444;
    }
    body{margin:0;background:var(--dark);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px;}
    h1{margin:0 0 18px;font-size:22px}
    .card{background:#0f1524;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:#0f1524;color:#dbeafe;outline:none;font-size:14px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:8px;align-items:center;margin-top:12px}
    button{padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#101727}
    .dot{width:8px;height:8px;border-radius:999px;background:#64748b}
    .dot.pos{background:#19c37d}.dot.neu{background:#f59e0b}.dot.neg{background:#ef4444}
    .signal{display:flex;align-items:center;gap:8px}
    .bullet{width:10px;height:10px;border-radius:10px;background:#ef4444}
    .bullet.ambar{background:#f59e0b}.bullet.verde{background:#22c55e}
    .muted{color:#94a3b8}
    .ratings{display:none;gap:8px}
    .good{background:#19c37d;color:#062d1f}.regular{background:#fbbf24;color:#332200}.bad{background:#ef4444;color:#fff}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>FerBot ‚Äî Panel</h1>
    <div class="card">
      <div class="footer" style="margin:0 0 12px">
        <div class="signal">
          <div class="bullet" id="b"></div>
          <div class="muted" id="t">0.0s</div>
        </div>
        <div class="pill"><span class="dot neu" id="sd"></span><span id="st">Neutral</span></div>
      </div>

      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
      </div>

      <label style="margin-top:6px">Contexto (opcional, para el bot)</label>
      <input id="ctx" placeholder="Ej. pregunt√≥ por certificaciones; poco tiempo"/>

      <label style="margin-top:6px">Texto del cliente</label>
      <textarea id="q" placeholder="Pega aqu√≠ lo que dijo el cliente o su objeci√≥n‚Ä¶"></textarea>

      <label style="margin-top:6px">Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
      <textarea id="why" placeholder="Aqu√≠ ver√°s POR QU√â y SIGUIENTE PASO."></textarea>

      <label style="margin-top:6px">Respuesta (lista para pegar)</label>
      <textarea id="out" placeholder="Mensaje corto para el cliente (‚â§ 2 frases)."></textarea>

      <div class="footer">
        <div class="btns">
          <button id="gen" class="primary">Generar</button>
          <button id="clear" class="ghost">Clear</button>
        </div>
        <div class="btns ratings" id="rts">
          <button id="rGood" class="good">üëç Buena</button>
          <button id="rReg"  class="regular">üòê Regular</button>
          <button id="rBad"  class="bad">üëé Mala</button>
        </div>
      </div>
    </div>
    <p class="muted" style="margin-top:10px">Hecho con amor üíö</p>
  </div>

<script>
const BASE = (localStorage.getItem("ferbot_api_base") || "").trim() || location.origin;

const el = id => document.getElementById(id);
const name = el("name"), stage = el("stage"), ctx = el("ctx"), q = el("q");
const why = el("why"), out = el("out"), gen = el("gen"), clear = el("clear");
const b = el("b"), t = el("t"), sd = el("sd"), st = el("st"), rts = el("rts"), rGood = el("rGood"), rReg = el("rReg"), rBad = el("rBad");

name.value = localStorage.getItem("ferbot_name") || "";
name.addEventListener("change", ()=> localStorage.setItem("ferbot_name", name.value.trim()));

function badge(text){
  const s = (text||"").toLowerCase();
  let cls = "neu", label="Neutral";
  if (/(no puedo|caro|malo|no sirve|no tengo tiempo|no s√©|no se|dif√≠cil)/.test(s)) { cls="neg"; label="Negativo"; }
  else if (/(gracias|excelente|me interesa|bien|listo|perfecto|genial|s√≠|si)/.test(s)) { cls="pos"; label="Positivo"; }
  sd.classList.remove("pos","neu","neg"); sd.classList.add(cls); st.textContent = label;
}
q.addEventListener("input", ()=> badge(q.value));

let iv=null, t0=0;
function start() {
  stop(); t0 = performance.now(); setColor("rojo");
  iv = setInterval(()=> {
    const dt = (performance.now() - t0)/1000;
    t.textContent = dt.toFixed(1) + "s";
    if (dt < 2) setColor("rojo");
    else if (dt < 4) setColor("ambar");
    else setColor("verde");
  }, 100);
}
function stop(){ if (iv){ clearInterval(iv); iv=null; } }
function setColor(c){ b.classList.remove("ambar","verde"); if (c==="ambar") b.classList.add("ambar"); else if (c==="verde") b.classList.add("verde"); }

function toggleRatings(show){ rts.style.display = show ? "flex" : "none"; }

gen.onclick = async () => {
  const question = (q.value||"").trim();
  if (!question){ alert("Escribe el texto del cliente."); return; }
  why.value = ""; out.value = ""; toggleRatings(false); badge(question); start();
  try {
    const body = { question, customerName:(name.value||"Cliente"), stage:stage.value, context:(ctx.value||""), intent:guessIntent(question) };
    const res = await fetch(`${BASE}/assist_trainer`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    stop(); setColor("verde");
    if (!res.ok){ const txt = await res.text().catch(()=> ""); alert("No se pudo generar. " + txt); return; }
    const json = await res.json();
    const reply = (json?.result?.reply || json?.text || "").trim();
    const py    = (json?.result?.why  || "").trim();
    const nx    = (json?.result?.next || "").trim();
    out.value = reply;
    why.value = `POR QU√â: ${py}\nSIGUIENTE PASO: ${nx}`;
    window.__lastReply = reply; window.__lastStage = stage.value; window.__lastIntent = body.intent;
    toggleRatings(true);
  } catch(e){ stop(); alert("Error de red. Revisa que el servidor est√© arriba."); }
};

clear.onclick = () => { why.value=""; out.value=""; stop(); setColor("rojo"); t.textContent="0.0s"; toggleRatings(false); };

rGood.onclick = ()=> rate("good");
rReg.onclick  = ()=> rate("regular");
rBad.onclick  = ()=> rate("bad");
async function rate(kind){
  try{
    const text = window.__lastReply || ""; if (!text) return;
    await fetch(`${BASE}/trackRate`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ intent:(window.__lastIntent||"_panel"), stage:(window.__lastStage||"integracion"), text, rating:kind })
    });
  }catch(_){}
  toggleRatings(false);
}

function guessIntent(q=""){
  const s=(q||"").toLowerCase();
  if (/(tiempo|no tengo tiempo|poco tiempo|agenda|horario|no alcanzo|ocupad)/.test(s)) return "tiempo";
  if (/(precio|caro|costo|costoso|vale|promoci|oferta|descuento)/.test(s)) return "precio";
  if (/(cert|certificado|certificaci√≥n|certificaciones)/.test(s)) return "cert";
  if (/(coursera|udemy|alura|competenc)/.test(s)) return "competencia";
  if (/(qu√© es platzi|que es platzi|platzi|pitch)/.test(s)) return "pitch";
  return "_panel";
}
</script>
</body>
</html>

