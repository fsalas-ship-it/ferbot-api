<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>FerBot ‚Äî Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Evitar cach√© de GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <style>
    :root { --bg:#0b0f19; --card:#0f1524; --txt:#e2e8f0; --mut:#94a3b8; --green:#97C93E; }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter}
    .wrap{max-width:880px;margin:24px auto;padding:0 16px}
    h1{font-size:18px;margin:0 0 12px;display:flex;align-items:center;gap:8px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;font-size:12px;color:var(--mut);margin:8px 0 6px}
    input,select,textarea{width:100%;background:#0d1322;color:#dbeafe;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:9px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--green);color:#0b0f19}
    .ghost{background:#1b2333;color:#cbd5e1}
    .hint{font-size:12px;color:var(--mut)}
    .kpi{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:#ef4444} /* rojo */
    .dot.yellow{background:#f59e0b}
    .dot.green{background:#22c55e}
    .right{display:flex;gap:10px;align-items:center}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .made{opacity:.7;font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ü§ñ FerBot ‚Äî Panel</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura">
        </div>
        <div>
          <label>Etapa</label>
          <select id="stage">
            <option value="sondeo">Sondeo</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="cierre">Cierre</option>
            <option value="integracion">Integraci√≥n</option>
          </select>
        </div>
      </div>

      <label style="margin-top:6px;">Contexto (opcional, para el bot)</label>
      <input id="ctx" placeholder="Breve contexto (ej. certificaciones, poco tiempo, ingl√©s)‚Ä¶">

      <label style="margin-top:6px;">Texto del cliente</label>
      <textarea id="q" placeholder="Pega aqu√≠ lo que dijo el cliente‚Ä¶"></textarea>

      <div class="kpi">
        <div id="dot" class="dot"></div>
        <div id="timer" class="hint">0.0 s</div>
        <div class="right">
          <button id="g" class="primary">Generar</button>
          <button id="clear" class="ghost">Clear</button>
        </div>
      </div>

      <div class="hr"></div>

      <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
      <textarea id="guide" placeholder="Aqu√≠ el bot te ense√±a‚Ä¶"></textarea>

      <label>Respuesta (lista para pegar)</label>
      <textarea id="out" placeholder="Se generar√° aqu√≠‚Ä¶"></textarea>

      <div class="btns">
        <button id="rate-good" class="ghost">üëç Buena</button>
        <button id="rate-regular" class="ghost">üòê Regular</button>
        <button id="rate-bad" class="ghost">üëé Mala</button>
      </div>

      <div class="made">hecho con amor <span style="color:#97C93E">‚ù§</span></div>
    </div>

    <div class="hint">Base de API actual: <code id="baseLabel"></code></div>
  </div>

  <script>
    // === Config de base ===
    const DEFAULT_BASE = "https://ferbot-api.onrender.com";
    const API_BASE = localStorage.getItem("ferbot_api_base") || DEFAULT_BASE;
    document.getElementById("baseLabel").textContent = API_BASE;

    // === Refs ===
    const elQ = document.getElementById('q');
    const elName = document.getElementById('name');
    const elStage = document.getElementById('stage');
    const elCtx = document.getElementById('ctx');
    const elOut = document.getElementById('out');
    const elGuide = document.getElementById('guide');
    const elG = document.getElementById('g');
    const elClear = document.getElementById('clear');
    const elDot = document.getElementById('dot');
    const elTimer = document.getElementById('timer');
    const rateGood = document.getElementById('rate-good');
    const rateRegular = document.getElementById('rate-regular');
    const rateBad = document.getElementById('rate-bad');

    // === Timer + status dot ===
    let t0 = 0, tickId = 0;
    function startTimer(){
      t0 = performance.now();
      elTimer.textContent = "0.0 s";
      elDot.className = "dot"; // rojo
      clearInterval(tickId);
      tickId = setInterval(()=>{
        const s = (performance.now()-t0)/1000;
        elTimer.textContent = s.toFixed(1) + " s";
        if (s > 1.5) elDot.className = "dot yellow";
      }, 100);
    }
    function stopTimerOk(){
      clearInterval(tickId);
      const s = (performance.now()-t0)/1000;
      elTimer.textContent = s.toFixed(1) + " s";
      elDot.className = "dot green";
    }
    function stopTimerErr(){
      clearInterval(tickId);
      elDot.className = "dot";
    }

    // === Rating (desaparecen tras votar) ===
    function hideRatings(){
      rateGood.style.display = rateRegular.style.display = rateBad.style.display = "none";
    }
    function showRatings(){
      rateGood.style.display = rateRegular.style.display = rateBad.style.display = "";
    }

    // === Clicks ===
    elClear.addEventListener('click', ()=>{
      elOut.value = "";
      elGuide.value = "";
      showRatings();
      elTimer.textContent = "0.0 s";
      elDot.className = "dot";
    });

    elG.addEventListener('click', onGenerate);

    async function onGenerate(){
      const question = elQ.value.trim();
      if (!question){ alert("Escribe el texto del cliente."); return; }
      const body = {
        question,
        customerName: elName.value.trim() || "Cliente",
        stage: elStage.value,
        context: elCtx.value.trim()
      };

      try{
        startTimer();
        const r = await fetch(API_BASE + "/assist_trainer", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        if(!r.ok){
          const txt = await r.text().catch(()=> "");
          stopTimerErr();
          alert("Error ("+r.status+"): " + txt);
          return;
        }
        const j = await r.json();
        stopTimerOk();
        const reply = (j?.text || j?.result?.reply || "").trim();
        const why  = (j?.result?.why  || "").trim();
        const next = (j?.result?.next || "").trim();
        elOut.value = reply || "";
        elGuide.value = `POR QU√â: ${why || "-"}\nSIGUIENTE PASO: ${next || "-"}`;
        // mostrar rating solo cuando hay respuesta
        showRatings();
      }catch(e){
        stopTimerErr();
        alert("No se pudo conectar con la API. Revisa /health.");
      }
    }

    async function sendRating(rating){
      const text = elOut.value.trim();
      if(!text) return;
      try{
        await fetch(API_BASE + "/trackRate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            intent:"_panel",
            stage: elStage.value,
            text, rating
          })
        });
        hideRatings(); // desaparecen tras votar
      }catch(_){}
    }
    rateGood.addEventListener('click', ()=> sendRating('good'));
    rateRegular.addEventListener('click', ()=> sendRating('regular'));
    rateBad.addEventListener('click', ()=> sendRating('bad'));
  </script>
</body>
</html>
