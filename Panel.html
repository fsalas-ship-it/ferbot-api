<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FerBot ‚Äî Panel</title>
<style>
  :root{
    --bg:#0b0f19; --card:#0f1524; --muted:#94a3b8; --ink:#e2e8f0; --line:rgba(255,255,255,.10);
    --green:#19c37d; --platzi:#97C93E; --yellow:#f59e0b; --red:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
  .wrap{max-width:880px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.35)}
  h1{margin:0 0 16px;font-size:18px;display:flex;align-items:center;gap:8px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:240px}
  label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
  input,select,textarea{
    width:100%;background:#0f1524;color:#dbeafe;border:1px solid var(--line);border-radius:10px;
    padding:9px 11px;outline:none;font-size:14px
  }
  textarea{min-height:110px;resize:vertical}
  .footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .btn{border:0;border-radius:9px;padding:9px 12px;cursor:pointer;font-weight:800}
  .primary{background:var(--platzi);color:#0b0f19}
  .ghost{background:#1b2333;color:#cbd5e1}
  .good{background:var(--green);color:#062d1f}
  .warn{background:var(--yellow);color:#231500}
  .bad{background:var(--red);color:#fff}
  .pill{font-size:12px;padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#0e1424;color:#cbd5e1}
  .timer{min-width:72px;text-align:center;font-variant-numeric:tabular-nums;font-weight:800;padding:8px 10px;border-radius:999px;border:1px solid var(--line)}
  .timer.red{background:var(--red);color:#fff}
  .timer.yellow{background:var(--yellow);color:#231500}
  .timer.green{background:var(--green);color:#062d1f}
  .muted{color:var(--muted);font-size:12px}
  .error{margin-top:8px;color:#fff;background:#7f1d1d;border:1px solid #b91c1c;padding:8px 10px;border-radius:10px;display:none;white-space:pre-wrap}
  .ok{display:inline-flex;align-items:center;gap:6px}
  .hint{font-size:12px;opacity:.85}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ü§ñ FerBot ‚Äî Panel <span class="hint">¬∑ hecho con amor üíö</span></h1>

      <div class="row">
        <div class="col">
          <label>Nombre del cliente</label>
          <input id="name" placeholder="Ej. Laura"/>
        </div>
        <div class="col">
          <label>Etapa</label>
          <select id="stage">
            <option value="integracion">Integraci√≥n</option>
            <option value="sondeo">Sondeo</option>
            <option value="pre_cierre">Pre-cierre</option>
            <option value="rebatir" selected>Rebatir</option>
            <option value="cierre">Cierre</option>
          </select>
        </div>
        <div class="col" style="max-width:180px">
          <label>Sentimiento</label>
          <div id="sent" class="pill">Neutro</div>
        </div>
      </div>

      <label>Contexto (opcional, para el bot)</label>
      <input id="ctx" placeholder="Ej. certificaciones; poco tiempo al d√≠a">

      <label style="margin-top:8px">Texto del cliente</label>
      <textarea id="input" placeholder="Escribe la frase o pega texto del cliente‚Ä¶"></textarea>

      <label>Explicaci√≥n (POR QU√â + SIGUIENTE PASO)</label>
      <textarea id="guide" placeholder="Aqu√≠ el bot te ense√±a‚Ä¶" readonly></textarea>

      <label>Respuesta (lista para pegar)</label>
      <textarea id="out" placeholder="Se generar√° aqu√≠‚Ä¶" readonly></textarea>

      <div id="err" class="error"></div>

      <div class="footer">
        <button id="gen"   class="btn primary">Generar</button>
        <button id="clear" class="btn ghost">Clear</button>

        <span class="pill">Tiempo</span>
        <span id="timer" class="timer">00.0s</span>

        <span style="flex:1"></span>

        <span class="pill">¬øTe gust√≥ esta respuesta?</span>
        <button id="rate-good" class="btn good"   style="display:none">üëç Buena</button>
        <button id="rate-reg"  class="btn warn"   style="display:none">üòê Regular</button>
        <button id="rate-bad"  class="btn bad"    style="display:none">üëé Mala</button>
        <span id="rated" class="pill" style="display:none">¬°Gracias por calificar!</span>
      </div>

      <div class="muted" style="margin-top:10px">
        API: <code id="apiLabel"></code>
        ¬∑ <span id="health" class="ok"></span>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- BASE de la API ----------
  const urlParam = new URLSearchParams(location.search).get("api");
  const BASE = urlParam || localStorage.getItem("ferbot_api_base") || "https://ferbot-api.onrender.com";
  document.getElementById("apiLabel").textContent = BASE;
  // Guarda si vino por query
  if (urlParam) localStorage.setItem("ferbot_api_base", urlParam);

  // ---------- Refs ----------
  const nameEl = document.getElementById("name");
  const stageEl= document.getElementById("stage");
  const ctxEl  = document.getElementById("ctx");
  const inEl   = document.getElementById("input");
  const outEl  = document.getElementById("out");
  const guideEl= document.getElementById("guide");
  const errBox = document.getElementById("err");
  const sentEl = document.getElementById("sent");
  const tEl    = document.getElementById("timer");
  const btnGen = document.getElementById("gen");
  const btnClr = document.getElementById("clear");
  const rGood  = document.getElementById("rate-good");
  const rReg   = document.getElementById("rate-reg");
  const rBad   = document.getElementById("rate-bad");
  const rated  = document.getElementById("rated");
  const health = document.getElementById("health");

  nameEl.value = localStorage.getItem("ferbot_name") || "";
  nameEl.addEventListener("change", ()=> localStorage.setItem("ferbot_name", nameEl.value.trim()));

  // ---------- Health ----------
  fetch(`${BASE}/health`).then(r=>r.json()).then(j=>{
    health.textContent = j.ok ? `ok: true, model_env: "${j.model_env}"` : "ok: false";
  }).catch(_=> { health.textContent = "sin respuesta"; });

  // ---------- Sentimiento simple ----------
  function updateSentiment(text=""){
    const s = (text||"").toLowerCase();
    const neg = /(no tengo tiempo|caro|no puedo|dif√≠cil|no me sirve|muy caro)/.test(s);
    const pos = /(me interesa|me gusta|quiero|perfecto|genial|excelente|s√≠|si)/.test(s);
    let label = "Neutro", color = "#94a3b8";
    if (neg && !pos) { label="Negativo"; color="#ef4444"; }
    else if (pos && !neg) { label="Positivo"; color="#19c37d"; }
    sentEl.textContent = label;
    sentEl.style.borderColor = color;
    sentEl.style.color = color;
  }
  inEl.addEventListener("input", ()=> updateSentiment(inEl.value));

  // ---------- Timer ----------
  let t0=0, tid=null;
  function startTimer(){
    stopTimer();
    t0 = performance.now();
    tEl.classList.remove("green","yellow");
    tEl.classList.add("red");
    tid = setInterval(()=>{
      const s = (performance.now()-t0)/1000;
      tEl.textContent = s.toFixed(1)+"s";
      if (s >= 1.5 && s < 3) { tEl.classList.remove("red","green"); tEl.classList.add("yellow"); }
      else if (s >= 3)     { tEl.classList.remove("red","yellow"); tEl.classList.add("green"); }
    },100);
  }
  function stopTimer(){ if (tid) clearInterval(tid); tid=null; }
  function doneTimer(){
    stopTimer();
    const s = (performance.now()-t0)/1000;
    tEl.textContent = s.toFixed(1)+"s";
    tEl.classList.remove("red","yellow"); tEl.classList.add("green");
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function showRating(){
    rGood.style.display = rReg.style.display = rBad.style.display = "inline-block";
    rated.style.display = "none";
  }
  function hideRating(){
    rGood.style.display = rReg.style.display = rBad.style.display = "none";
  }

  // ---------- Generar ----------
  btnGen.addEventListener("click", async ()=>{
    clearError();
    hideRating();
    outEl.value = ""; guideEl.value = "";
    const question = (inEl.value || "").trim();
    if (!question) { showError("Escribe el texto del cliente primero."); return; }

    const payload = {
      question,
      customerName: nameEl.value.trim() || "Cliente",
      stage: stageEl.value,
      context: ctxEl.value.trim()
    };

    startTimer();
    try{
      const res = await fetch(`${BASE}/assist_trainer`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const txt = await res.text().catch(()=> "");
        showError(`No se pudo generar (HTTP ${res.status}). ${txt}`);
        doneTimer();
        return;
      }
      const j = await res.json();
      const reply = (j?.result?.reply || j?.text || "").trim();
      const why   = (j?.result?.why   || "").trim();
      const next  = (j?.result?.next  || "").trim();

      outEl.value   = reply || "";
      guideEl.value = `POR QU√â: ${why || "-"}\nSIGUIENTE PASO: ${next || "-"}`;
      showRating();
    }catch(e){
      showError("Error de red: " + (e?.message || String(e)));
    }finally{
      doneTimer();
    }
  });

  // ---------- Clear ----------
  btnClr.addEventListener("click", ()=>{
    outEl.value = ""; guideEl.value = "";
    hideRating(); rated.style.display = "none";
    tEl.textContent = "00.0s"; tEl.classList.remove("red","yellow","green");
    clearError();
  });

  // ---------- Rating (se oculta tras votar) ----------
  async function rate(kind){
    const text = (outEl.value || "").trim(); if(!text) return;
    try{
      await fetch(`${BASE}/trackRate`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ intent: "_panel_", stage: stageEl.value, text, rating: kind })
      });
    }catch(_){}
    hideRating(); rated.style.display = "inline-flex";
  }
  rGood.onclick = ()=> rate("good");
  rReg.onclick  = ()=> rate("regular");
  rBad.onclick  = ()=> rate("bad");

  // Inicial
  updateSentiment("");
})();
</script>
</body>
</html>
